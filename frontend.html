<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NjordHR - Dashboard Complete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-color: #3b82f6; color: #3b82f6; }
        .log-area { height: 24rem; }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow { animation: pulse-slow 2s ease-in-out infinite; }
        
        @keyframes scale-in {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        .animate-scale-in {
            animation: scale-in 0.3s ease-out;
        }

        :focus-visible {
            outline: 3px solid #1d4ed8;
            outline-offset: 2px;
        }
        
        .dashboard-table {
            font-size: 0.875rem;
        }
        
        .dashboard-table th {
            position: sticky;
            top: 0;
            background: #f3f4f6;
            z-index: 10;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
            .truncate-reason {
                max-width: 300px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .download-indeterminate {
                position: relative;
                overflow: hidden;
            }

            .download-indeterminate::after {
                content: "";
                position: absolute;
                top: 0;
                left: -35%;
                width: 35%;
                height: 100%;
                background: linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.65), rgba(255,255,255,0.15));
                animation: download-shimmer 1.2s linear infinite;
            }

            @keyframes download-shimmer {
                0% { left: -35%; }
                100% { left: 100%; }
            }
        </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [activeTab, setActiveTab] = useState('download');
            const [toasts, setToasts] = useState([]);
            const [isOtpSending, setIsOtpSending] = useState(false);
            const [isOtpVerifying, setIsOtpVerifying] = useState(false);
            const [isDisconnecting, setIsDisconnecting] = useState(false);
            const [isDownloadLoading, setIsDownloadLoading] = useState(false);
            const [isAnalyzeLoading, setIsAnalyzeLoading] = useState(false);
            const [isVerifyingResumes, setIsVerifyingResumes] = useState(false);
            
            const [sessionConnected, setSessionConnected] = useState(false);
            const [loginStep, setLoginStep] = useState('phone');
            const [phoneNumber, setPhoneNumber] = useState('');
            const [otp, setOtp] = useState('');
            const [otpExpiresAt, setOtpExpiresAt] = useState(null);
            const [otpSecondsLeft, setOtpSecondsLeft] = useState(null);

            const [ranks, setRanks] = useState([]);
            const [shipTypes, setShipTypes] = useState([]);
            const [selectedRank, setSelectedRank] = useState('');
            const [selectedShipType, setSelectedShipType] = useState('');
            const [forceRedownload, setForceRedownload] = useState(false);
            const [downloadLog, setDownloadLog] = useState([]);
            const [logFile, setLogFile] = useState(null);
            const [isDownloadInProgress, setIsDownloadInProgress] = useState(false);
            const [downloadElapsedSeconds, setDownloadElapsedSeconds] = useState(0);
            const [downloadCompleted, setDownloadCompleted] = useState(false);

            const [rankFolders, setRankFolders] = useState([]);
            const [selectedRankFolder, setSelectedRankFolder] = useState('');
            const [aiPrompt, setAiPrompt] = useState('');
            const [analysisResults, setAnalysisResults] = useState(null);
            
            const [analysisProgress, setAnalysisProgress] = useState({
                isAnalyzing: false,
                stage: 'idle',
                current: 0,
                total: 0,
                message: '',
                liveVerified: [],
                liveUncertain: []
            });
            
            const [selectedFiles, setSelectedFiles] = useState(new Set());
            const [feedbackNotes, setFeedbackNotes] = useState({});
            const [verifyStatus, setVerifyStatus] = useState('idle');
            
            // Dashboard state
            const [dashboardView, setDashboardView] = useState('master');
            const [dashboardRank, setDashboardRank] = useState('');
            const [availableRanks, setAvailableRanks] = useState([]);
            const [dashboardData, setDashboardData] = useState([]);
            const [selectedDashboardIds, setSelectedDashboardIds] = useState(new Set());
            const [isExporting, setIsExporting] = useState(false);
            const [exportCompleted, setExportCompleted] = useState(false);
            const [historyModal, setHistoryModal] = useState({ open: false, candidateId: '', rows: [] });
            const [filteredData, setFilteredData] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const [rowsPerPage] = useState(20);
            const [sortColumn, setSortColumn] = useState('date_added');
            const [sortOrder, setSortOrder] = useState('desc');
            const [isDashboardLoading, setIsDashboardLoading] = useState(false);
            const [reviewCompleted, setReviewCompleted] = useState(false);
            const [isDashboardDrawerOpen, setIsDashboardDrawerOpen] = useState(false);
            const [drawerCandidateId, setDrawerCandidateId] = useState('');
            const [drawerNoteSeed, setDrawerNoteSeed] = useState('');
            const [adminSessionPassword, setAdminSessionPassword] = useState('');
            const [isSettingsLoading, setIsSettingsLoading] = useState(false);
            const [isSettingsSaving, setIsSettingsSaving] = useState(false);
            const [settingsLoaded, setSettingsLoaded] = useState(false);
            const [settingsSection, setSettingsSection] = useState('runtime');
            const [settingsForm, setSettingsForm] = useState({
                default_download_folder: '',
                verified_resumes_folder: 'Verified_Resumes',
                seajob_login_url: 'http://seajob.net/seajob_login.php',
                seajob_dashboard_url: 'http://seajob.net/company/dashboard.php',
                otp_window_seconds: '120',
                registry_db_path: 'registry.db',
                feedback_db_path: 'feedback.db',
                log_dir: 'logs',
                pinecone_environment: '',
                pinecone_index_name: '',
                embedding_model_name: '',
                reasoning_model_name: '',
                min_similarity_score: '0.25',
                supabase_url: '',
                use_supabase_db: false,
                use_dual_write: false,
                use_supabase_reads: false,
                use_local_agent: false,
                use_cloud_export: false,
                seajob_username: '',
                seajob_password: '',
                gemini_api_key: '',
                pinecone_api_key: '',
                supabase_secret_key: '',
            });
            const [settingsMasks, setSettingsMasks] = useState({
                seajob_username: { configured: false, preview: '' },
                seajob_password: { configured: false, preview: '' },
                gemini_api_key: { configured: false, preview: '' },
                pinecone_api_key: { configured: false, preview: '' },
                supabase_secret_key: { configured: false, preview: '' },
            });
            const [adminPasswordForm, setAdminPasswordForm] = useState({
                current_password: '',
                new_password: '',
                confirm_password: '',
            });
            const [folderPicker, setFolderPicker] = useState({
                open: false,
                targetKey: '',
                currentPath: '',
                parentPath: '',
                entries: [],
                loading: false,
            });
            
            const eventSourceRef = useRef(null);
            const downloadEventSourceRef = useRef(null);
            const dashboardTableScrollRef = useRef(null);
            const drawerNoteInputRef = useRef(null);
            const adminPasswordInputRef = useRef(null);
            
            const API_BASE_URL = window.NJORDHR_API_BASE_URL
                || (window.location.protocol.startsWith('http') ? window.location.origin : 'http://127.0.0.1:5000');
            const STATUS_OPTIONS = ['New', 'Contacted', 'Interested', 'Not Interested', 'Interview Scheduled', 'Offer Made', 'Hired', 'Rejected'];
            const WORKFLOW_STEPS = ['Connect', 'Download', 'Analyze', 'Review', 'Export'];

            useEffect(() => {
                fetchRankFolders();
            }, [downloadLog]);
            
            useEffect(() => {
                if (activeTab === 'dashboard') {
                    fetchAvailableRanks();
                    fetchDashboardData({ resetPage: true });
                }
            }, [activeTab]);

            useEffect(() => {
                fetchDashboardData({ resetPage: true });
            }, [dashboardView, dashboardRank]);
            
            useEffect(() => {
                filterAndSortData();
            }, [dashboardData, searchQuery, sortColumn, sortOrder]);

            useEffect(() => {
                const totalPages = Math.max(1, Math.ceil(filteredData.length / rowsPerPage));
                if (currentPage > totalPages) {
                    setCurrentPage(totalPages);
                }
            }, [filteredData, currentPage, rowsPerPage]);

            useEffect(() => {
                setSelectedDashboardIds(prev => {
                    const validIds = new Set(dashboardData.map(row => String(row.candidate_id)));
                    return new Set([...prev].filter(id => validIds.has(id)));
                });
            }, [dashboardData]);

            useEffect(() => {
                if (!isDashboardDrawerOpen || !drawerCandidateId) return;
                const exists = dashboardData.some(row => String(row.candidate_id) === String(drawerCandidateId));
                if (!exists) {
                    setIsDashboardDrawerOpen(false);
                    setDrawerCandidateId('');
                }
            }, [dashboardData, isDashboardDrawerOpen, drawerCandidateId]);

            useEffect(() => {
                if (!isDashboardDrawerOpen || !drawerCandidateId) return;
                // Always start with an empty note input when opening/switching drawer candidate.
                setDrawerNoteSeed('');
                if (drawerNoteInputRef.current) {
                    drawerNoteInputRef.current.value = '';
                }
            }, [isDashboardDrawerOpen, drawerCandidateId, dashboardData]);

            useEffect(() => {
                if (!otpExpiresAt || loginStep !== 'otp') {
                    setOtpSecondsLeft(null);
                    return;
                }

                const tick = () => {
                    const seconds = Math.max(0, Math.ceil((otpExpiresAt - Date.now()) / 1000));
                    setOtpSecondsLeft(seconds);
                    if (seconds <= 0) {
                        setLoginStep('phone');
                        setOtp('');
                        setOtpExpiresAt(null);
                        handleSendMessage('error', 'OTP expired. Please request a new OTP.');
                    }
                };

                tick();
                const timer = setInterval(tick, 1000);
                return () => clearInterval(timer);
            }, [otpExpiresAt, loginStep]);

            useEffect(() => {
                if (!isDownloadInProgress) {
                    setDownloadElapsedSeconds(0);
                    return;
                }
                const timer = setInterval(() => {
                    setDownloadElapsedSeconds(prev => prev + 1);
                }, 1000);
                return () => clearInterval(timer);
            }, [isDownloadInProgress]);

            useEffect(() => {
                if (!sessionConnected && loginStep !== 'otp') return;

                const checkHealth = async () => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/session_health`);
                        const data = await response.json();
                        if (!data.success) return;

                        const health = data.health || {};
                        if (loginStep === 'otp') {
                            if (health.otp_expired || health.reason === 'Returned to login page') {
                                setLoginStep('phone');
                                setOtp('');
                                setOtpExpiresAt(null);
                                handleSendMessage('error', health.reason === 'OTP expired' ? 'OTP expired. Please request a new OTP.' : 'Session reset before OTP verification. Request OTP again.');
                            }
                        }

                        if (sessionConnected && !health.valid) {
                            setSessionConnected(false);
                            setLoginStep('phone');
                            setOtp('');
                            setOtpExpiresAt(null);
                            handleSendMessage('error', `Session disconnected: ${health.reason || 'Unknown reason'}`);
                        }
                    } catch (_error) {
                        // Best-effort polling; no UI disruption on transient failures.
                    }
                };

                checkHealth();
                const poller = setInterval(checkHealth, 15000);
                return () => clearInterval(poller);
            }, [sessionConnected, loginStep]);

            useEffect(() => {
                return () => {
                    if (eventSourceRef.current) {
                        eventSourceRef.current.close();
                    }
                    if (downloadEventSourceRef.current) {
                        downloadEventSourceRef.current.close();
                    }
                };
            }, []);

            useEffect(() => {
                const onKeyDown = (event) => {
                    if (event.key !== 'Escape') return;
                    if (isDashboardDrawerOpen) {
                        closeDashboardDrawer();
                    } else if (historyModal.open) {
                        setHistoryModal({ open: false, candidateId: '', rows: [] });
                    }
                };
                window.addEventListener('keydown', onKeyDown);
                return () => window.removeEventListener('keydown', onKeyDown);
            }, [isDashboardDrawerOpen, historyModal.open]);

            const fetchRankFolders = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/get_rank_folders`);
                    const data = await response.json();
                    if (data.success) {
                        setRankFolders(data.folders);
                        if (data.folders.length > 0 && !selectedRankFolder) {
                            setSelectedRankFolder(data.folders[0]);
                        }
                    }
                } catch (error) {
                    console.error("Could not fetch rank folders", error);
                }
            };
            
            const fetchAvailableRanks = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/get_available_ranks`);
                    const data = await response.json();
                    if (data.success) {
                        setAvailableRanks(data.ranks);
                        if (data.ranks.length > 0 && !dashboardRank) {
                            setDashboardRank(data.ranks[0].rank);
                        }
                    }
                } catch (error) {
                    console.error("Could not fetch available ranks", error);
                }
            };
            
            const fetchDashboardData = async ({ resetPage = false, preserveScroll = false } = {}) => {
                if (dashboardView === 'rank' && !dashboardRank) {
                    setDashboardData([]);
                    setFilteredData([]);
                    setIsDashboardLoading(false);
                    return;
                }
                const previousScrollTop = preserveScroll && dashboardTableScrollRef.current
                    ? dashboardTableScrollRef.current.scrollTop
                    : 0;
                setIsDashboardLoading(true);
                try {
                    let url = `${API_BASE_URL}/get_dashboard_data?view=${dashboardView}`;
                    if (dashboardView === 'rank' && dashboardRank) {
                        url += `&rank_name=${dashboardRank}`;
                    }
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.success) {
                        setDashboardData(data.data);
                        if (resetPage) {
                            setCurrentPage(1);
                        }
                    } else {
                        handleSendMessage('error', data.message || 'Failed to load dashboard data');
                    }
                } catch (error) {
                    console.error("Dashboard data fetch error:", error);
                    handleSendMessage('error', 'Failed to load dashboard data');
                } finally {
                    if (preserveScroll && dashboardTableScrollRef.current) {
                        setTimeout(() => {
                            if (dashboardTableScrollRef.current) {
                                dashboardTableScrollRef.current.scrollTop = previousScrollTop;
                            }
                        }, 0);
                    }
                    setIsDashboardLoading(false);
                }
            };

            const loadAdminSettings = async () => {
                const enteredPassword = ((adminPasswordInputRef.current && adminPasswordInputRef.current.value) || adminSessionPassword || '').trim();
                if (!enteredPassword) {
                    handleSendMessage('error', 'Enter admin password first');
                    return;
                }
                setIsSettingsLoading(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/settings`, {
                        // Admin-authenticated fetch can request full secret values.
                        // This is intentionally admin-only and never available without valid admin password.
                        method: 'GET',
                        headers: { 'X-Admin-Token': enteredPassword }
                    });
                    const responseWithSecrets = await fetch(`${API_BASE_URL}/admin/settings?include_secrets=true`, {
                        method: 'GET',
                        headers: { 'X-Admin-Token': enteredPassword }
                    });
                    const data = await response.json();
                    const dataWithSecrets = await responseWithSecrets.json();
                    if (!data.success) {
                        handleSendMessage('error', data.message || 'Failed to load admin settings');
                        return;
                    }
                    if (!dataWithSecrets.success) {
                        handleSendMessage('error', dataWithSecrets.message || 'Failed to load complete admin settings');
                        return;
                    }
                    const nonSecret = data.settings?.non_secret || {};
                    const secrets = data.settings?.secrets || {};
                    const secretsPlain = dataWithSecrets.settings?.secrets_plain || {};
                    setSettingsForm(prev => ({
                        ...prev,
                        default_download_folder: nonSecret.default_download_folder || '',
                        verified_resumes_folder: nonSecret.verified_resumes_folder || 'Verified_Resumes',
                        seajob_login_url: nonSecret.seajob_login_url || 'http://seajob.net/seajob_login.php',
                        seajob_dashboard_url: nonSecret.seajob_dashboard_url || 'http://seajob.net/company/dashboard.php',
                        otp_window_seconds: String(nonSecret.otp_window_seconds || '120'),
                        registry_db_path: nonSecret.registry_db_path || 'registry.db',
                        feedback_db_path: nonSecret.feedback_db_path || 'feedback.db',
                        log_dir: nonSecret.log_dir || 'logs',
                        pinecone_environment: nonSecret.pinecone_environment || '',
                        pinecone_index_name: nonSecret.pinecone_index_name || '',
                        embedding_model_name: nonSecret.embedding_model_name || '',
                        reasoning_model_name: nonSecret.reasoning_model_name || '',
                        min_similarity_score: String(nonSecret.min_similarity_score || '0.25'),
                        supabase_url: nonSecret.supabase_url || '',
                        use_supabase_db: Boolean(nonSecret.use_supabase_db),
                        use_dual_write: Boolean(nonSecret.use_dual_write),
                        use_supabase_reads: Boolean(nonSecret.use_supabase_reads),
                        use_local_agent: Boolean(nonSecret.use_local_agent),
                        use_cloud_export: Boolean(nonSecret.use_cloud_export),
                        seajob_username: secretsPlain.seajob_username || '',
                        seajob_password: secretsPlain.seajob_password || '',
                        gemini_api_key: secretsPlain.gemini_api_key || '',
                        pinecone_api_key: secretsPlain.pinecone_api_key || '',
                        supabase_secret_key: secretsPlain.supabase_secret_key || '',
                    }));
                    setSettingsMasks({
                        seajob_username: secrets.seajob_username || { configured: false, preview: '' },
                        seajob_password: secrets.seajob_password || { configured: false, preview: '' },
                        gemini_api_key: secrets.gemini_api_key || { configured: false, preview: '' },
                        pinecone_api_key: secrets.pinecone_api_key || { configured: false, preview: '' },
                        supabase_secret_key: secrets.supabase_secret_key || { configured: false, preview: '' },
                    });
                    setAdminSessionPassword(enteredPassword);
                    setSettingsSection('runtime');
                    setSettingsLoaded(true);
                    handleSendMessage('success', 'Admin settings loaded');
                } catch (error) {
                    handleSendMessage('error', 'Failed to load admin settings');
                } finally {
                    setIsSettingsLoading(false);
                }
            };

            const testSupabaseSettings = async () => {
                if (!adminSessionPassword.trim()) {
                    handleSendMessage('error', 'Enter admin password first');
                    return;
                }
                setIsSettingsSaving(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/settings/test_supabase`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Admin-Token': adminSessionPassword.trim(),
                        },
                        body: JSON.stringify({
                            supabase_url: settingsForm.supabase_url,
                            supabase_secret_key: settingsForm.supabase_secret_key,
                        }),
                    });
                    const data = await response.json();
                    if (!data.success) {
                        handleSendMessage('error', data.message || 'Supabase test failed');
                        return;
                    }
                    handleSendMessage('success', data.message || 'Supabase connection successful');
                } catch (error) {
                    handleSendMessage('error', 'Supabase test failed');
                } finally {
                    setIsSettingsSaving(false);
                }
            };

            const saveAdminSettings = async () => {
                if (!adminSessionPassword.trim()) {
                    handleSendMessage('error', 'Enter admin password first');
                    return;
                }
                setIsSettingsSaving(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Admin-Token': adminSessionPassword.trim(),
                        },
                        body: JSON.stringify({ settings: settingsForm }),
                    });
                    const data = await response.json();
                    if (!data.success) {
                        handleSendMessage('error', data.message || 'Failed to save settings');
                        return;
                    }
                    handleSendMessage('success', data.message || 'Settings saved');
                    setSettingsLoaded(false);
                    await loadAdminSettings();
                } catch (error) {
                    handleSendMessage('error', 'Failed to save settings');
                } finally {
                    setIsSettingsSaving(false);
                }
            };

            const loadFolderPickerPath = async (pathValue, targetKey) => {
                if (!adminSessionPassword.trim()) {
                    handleSendMessage('error', 'Enter admin password first');
                    return;
                }
                setFolderPicker(prev => ({ ...prev, open: true, loading: true, targetKey }));
                try {
                    const query = pathValue ? `?path=${encodeURIComponent(pathValue)}` : '';
                    const response = await fetch(`${API_BASE_URL}/admin/fs/list${query}`, {
                        headers: { 'X-Admin-Token': adminSessionPassword.trim() }
                    });
                    const data = await response.json();
                    if (!data.success) {
                        handleSendMessage('error', data.message || 'Failed to browse folders');
                        setFolderPicker(prev => ({ ...prev, loading: false }));
                        return;
                    }
                    setFolderPicker(prev => ({
                        ...prev,
                        open: true,
                        targetKey,
                        currentPath: data.current_path || '',
                        parentPath: data.parent_path || '',
                        entries: data.entries || [],
                        loading: false,
                    }));
                } catch (error) {
                    setFolderPicker(prev => ({ ...prev, loading: false }));
                    handleSendMessage('error', 'Failed to browse folders');
                }
            };

            const openFolderPicker = (targetKey) => {
                const seedPath = settingsForm[targetKey] || '';
                loadFolderPickerPath(seedPath, targetKey);
            };

            const selectFolderFromPicker = () => {
                if (!folderPicker.targetKey || !folderPicker.currentPath) return;
                setSettingsForm(prev => ({ ...prev, [folderPicker.targetKey]: folderPicker.currentPath }));
                setFolderPicker({
                    open: false,
                    targetKey: '',
                    currentPath: '',
                    parentPath: '',
                    entries: [],
                    loading: false,
                });
            };

            const changeAdminPassword = async () => {
                if (!adminSessionPassword.trim()) {
                    handleSendMessage('error', 'Enter current admin password first');
                    return;
                }
                const currentPassword = adminPasswordForm.current_password.trim();
                const newPassword = adminPasswordForm.new_password.trim();
                const confirmPassword = adminPasswordForm.confirm_password.trim();
                if (!currentPassword || !newPassword || !confirmPassword) {
                    handleSendMessage('error', 'Fill current, new and confirm password');
                    return;
                }
                if (currentPassword !== adminSessionPassword.trim()) {
                    handleSendMessage('error', 'Current password does not match active admin session');
                    return;
                }
                if (newPassword.length < 8) {
                    handleSendMessage('error', 'New admin password must be at least 8 characters');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    handleSendMessage('error', 'New password and confirmation do not match');
                    return;
                }

                setIsSettingsSaving(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/settings/change_password`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Admin-Token': adminSessionPassword.trim(),
                        },
                        body: JSON.stringify({
                            new_admin_password: newPassword,
                            confirm_admin_password: confirmPassword,
                        }),
                    });
                    const data = await response.json();
                    if (!data.success) {
                        handleSendMessage('error', data.message || 'Failed to update admin password');
                        return;
                    }
                    setAdminSessionPassword(newPassword);
                    if (adminPasswordInputRef.current) {
                        adminPasswordInputRef.current.value = '';
                    }
                    setAdminPasswordForm({ current_password: '', new_password: '', confirm_password: '' });
                    handleSendMessage('success', data.message || 'Admin password updated');
                } catch (error) {
                    handleSendMessage('error', 'Failed to update admin password');
                } finally {
                    setIsSettingsSaving(false);
                }
            };

            const generateAdminPassword = () => {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%^&*()-_=+';
                const length = 16;
                const bytes = new Uint32Array(length);
                if (window.crypto && window.crypto.getRandomValues) {
                    window.crypto.getRandomValues(bytes);
                } else {
                    for (let i = 0; i < length; i++) {
                        bytes[i] = Math.floor(Math.random() * 1_000_000);
                    }
                }
                let generated = '';
                for (let i = 0; i < length; i++) {
                    generated += chars[bytes[i] % chars.length];
                }
                setAdminPasswordForm(prev => ({
                    ...prev,
                    new_password: generated,
                    confirm_password: generated,
                }));
                handleSendMessage('success', 'Generated a strong admin password. Review and click Update.');
            };
            
            const filterAndSortData = () => {
                let filtered = [...dashboardData];
                
                // Apply search filter
                if (searchQuery.trim()) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(row => 
                        row.name.toLowerCase().includes(query) ||
                        row.email.toLowerCase().includes(query) ||
                        row.country.toLowerCase().includes(query) ||
                        row.present_rank.toLowerCase().includes(query) ||
                        (row.status || '').toLowerCase().includes(query) ||
                        (row.notes || '').toLowerCase().includes(query) ||
                        row.ai_match_reason.toLowerCase().includes(query)
                    );
                }
                
                // Apply sorting
                filtered.sort((a, b) => {
                    let aVal = a[sortColumn] || '';
                    let bVal = b[sortColumn] || '';
                    
                    // Handle date sorting
                    if (sortColumn === 'date_added') {
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    }
                    
                    if (aVal < bVal) return sortOrder === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
                
                setFilteredData(filtered);
            };
            
            const handleSort = (column) => {
                if (sortColumn === column) {
                    setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortColumn(column);
                    setSortOrder('desc');
                }
            };
            
            const formatDate = (isoString) => {
                if (!isoString) return '';
                try {
                    const date = new Date(isoString);
                    return date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                } catch {
                    return isoString;
                }
            };
            
            const getPaginatedData = () => {
                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = startIndex + rowsPerPage;
                return filteredData.slice(startIndex, endIndex);
            };

            const handleDashboardStatusChange = async (candidateId, status) => {
                const candidateIdStr = String(candidateId);
                try {
                    const response = await fetch(`${API_BASE_URL}/update_status`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ candidate_id: candidateId, status })
                    });
                    const data = await response.json();
                    if (!data.success) {
                        handleSendMessage('error', data.message || 'Failed to update status');
                        return;
                    }
                    setDashboardData(prev => prev.map(row =>
                        String(row.candidate_id) === candidateIdStr ? { ...row, status } : row
                    ));
                    handleSendMessage('success', `Status updated for candidate ${candidateId}`);
                    fetchDashboardData({ preserveScroll: true });
                } catch (error) {
                    handleSendMessage('error', 'Failed to update status');
                }
            };

            const handleDashboardAddNotes = async (candidateId, notesInput = null) => {
                const notes = (notesInput !== null ? notesInput : '').trim();
                if (!notes) {
                    handleSendMessage('error', 'Notes cannot be empty');
                    return;
                }

                const candidateIdStr = String(candidateId);
                try {
                    const response = await fetch(`${API_BASE_URL}/add_notes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ candidate_id: candidateId, notes })
                    });
                    const data = await response.json();
                    if (!data.success) {
                        handleSendMessage('error', data.message || 'Failed to add notes');
                        return;
                    }
                    setDashboardData(prev => prev.map(row =>
                        String(row.candidate_id) === candidateIdStr ? { ...row, notes } : row
                    ));
                    handleSendMessage('success', `Notes added for candidate ${candidateId}`);
                    if (String(drawerCandidateId) === candidateIdStr) {
                        setDrawerNoteSeed('');
                        if (drawerNoteInputRef.current) {
                            drawerNoteInputRef.current.value = '';
                        }
                    }
                    fetchDashboardData({ preserveScroll: true });
                } catch (error) {
                    handleSendMessage('error', 'Failed to add notes');
                }
            };

            const openDashboardDrawer = (candidateId) => {
                setDrawerCandidateId(String(candidateId));
                setIsDashboardDrawerOpen(true);
            };

            const closeDashboardDrawer = () => {
                setIsDashboardDrawerOpen(false);
                setDrawerCandidateId('');
                setDrawerNoteSeed('');
                if (drawerNoteInputRef.current) {
                    drawerNoteInputRef.current.value = '';
                }
            };

            const handleOpenHistory = async (candidateId) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/get_candidate_history/${encodeURIComponent(candidateId)}`);
                    const data = await response.json();
                    if (!data.success) {
                        handleSendMessage('error', data.message || 'Failed to load history');
                        return;
                    }
                    setHistoryModal({ open: true, candidateId, rows: data.history || [] });
                } catch (error) {
                    handleSendMessage('error', 'Failed to load history');
                }
            };

            const handleDashboardSelectAll = (checked) => {
                if (checked) {
                    const ids = filteredData.map(row => String(row.candidate_id));
                    setSelectedDashboardIds(new Set(ids));
                } else {
                    setSelectedDashboardIds(new Set());
                }
            };

            const handleDashboardRowSelect = (candidateId) => {
                const id = String(candidateId);
                setSelectedDashboardIds(prev => {
                    const next = new Set(prev);
                    if (next.has(id)) {
                        next.delete(id);
                    } else {
                        next.add(id);
                    }
                    return next;
                });
            };

            const handleExportResumes = async () => {
                if (selectedDashboardIds.size === 0) {
                    handleSendMessage('error', 'Select at least one candidate to export');
                    return;
                }

                setIsExporting(true);
                setExportCompleted(false);
                try {
                    const response = await fetch(`${API_BASE_URL}/export_resumes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ candidate_ids: Array.from(selectedDashboardIds) })
                    });

                    if (!response.ok) {
                        let err = {};
                        try { err = await response.json(); } catch {}
                        handleSendMessage('error', err.message || 'Failed to export resumes');
                        return;
                    }

                    const blob = await response.blob();
                    const exportedCount = parseInt(response.headers.get('X-Exported-Count') || '0', 10);
                    const includedFiles = parseInt(response.headers.get('X-Included-Files') || '0', 10);
                    const missingFiles = parseInt(response.headers.get('X-Missing-Files') || '0', 10);
                    const truncatedMissing = parseInt(response.headers.get('X-Missing-Files-Truncated') || '0', 10);
                    let missingPreview = [];
                    try {
                        missingPreview = JSON.parse(response.headers.get('X-Missing-Files-Preview') || '[]');
                    } catch {
                        missingPreview = [];
                    }

                    const contentDisposition = response.headers.get('content-disposition') || '';
                    let filename = 'njord_export.zip';
                    const match = contentDisposition.match(/filename=\"?([^\";]+)\"?/i);
                    if (match && match[1]) {
                        filename = match[1];
                    }

                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);

                    if (missingFiles > 0) {
                        const previewText = missingPreview.length
                            ? ` Missing: ${missingPreview.slice(0, 3).join(', ')}${(missingPreview.length > 3 || truncatedMissing > 0) ? ', ...' : ''}`
                            : '';
                        handleSendMessage(
                            'success',
                            `Export complete: selected ${exportedCount}, included ${includedFiles}, missing ${missingFiles}.${previewText}`
                        );
                    } else {
                        handleSendMessage('success', `Export complete: selected ${exportedCount}, included ${includedFiles}, missing 0.`);
                    }
                    setExportCompleted(true);
                } catch (error) {
                    handleSendMessage('error', 'Failed to export resumes');
                } finally {
                    setIsExporting(false);
                }
            };
            
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);

            const handleSendMessage = (type, text) => {
                const toastId = `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
                setToasts(prev => [...prev, { id: toastId, type, text }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== toastId));
                }, 6000);
            };

            const dismissToast = (toastId) => {
                setToasts(prev => prev.filter(t => t.id !== toastId));
            };

            const workflowState = {
                Connect: sessionConnected,
                Download: downloadCompleted,
                Analyze: Boolean(analysisResults && !analysisProgress.isAnalyzing),
                Review: reviewCompleted,
                Export: exportCompleted
            };

            const currentWorkflowStep = (() => {
                if (!workflowState.Connect) return 'Connect';
                if (!workflowState.Download) return 'Download';
                if (!workflowState.Analyze) return 'Analyze';
                if (!workflowState.Review) return 'Review';
                if (!workflowState.Export) return 'Export';
                return 'Export';
            })();

            const handleSendOTP = async () => {
                if (!phoneNumber) return handleSendMessage('error', 'Please enter a mobile number.');
                setIsOtpSending(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/start_session`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mobileNumber: phoneNumber }),
                    });
                    const data = await response.json();
                    if (data.success) {
                        handleSendMessage('success', data.message);
                        setLoginStep('otp');
                        const expiresIn = Number(data.otp_expires_in || 120);
                        setOtpExpiresAt(Date.now() + (expiresIn * 1000));
                    } else { handleSendMessage('error', data.message); }
                } catch (error) { handleSendMessage('error', 'Failed to connect to backend.'); }
                setIsOtpSending(false);
            };

            const handleVerifyOTP = async () => {
                if (!otp) return handleSendMessage('error', 'Please enter the OTP.');
                setIsOtpVerifying(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/verify_otp`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ otp }),
                    });
                    const data = await response.json();
                    if (data.success) {
                        handleSendMessage('success', 'Session started successfully!');
                        setRanks(data.ranks || []);
                        setShipTypes(data.ship_types || []);
                        setSelectedRank(data.ranks ? data.ranks[0] : '');
                        setSelectedShipType(data.ship_types ? data.ship_types[0] : '');
                        setSessionConnected(true);
                        setOtpExpiresAt(null);
                        setDownloadCompleted(false);
                        setReviewCompleted(false);
                        setExportCompleted(false);
                    } else {
                        handleSendMessage('error', data.message);
                        const msg = (data.message || '').toLowerCase();
                        if (msg.includes('incorrect otp')) {
                            setLoginStep('otp');
                        } else {
                            setLoginStep('phone');
                            setOtpExpiresAt(null);
                        }
                    }
                } catch (error) { handleSendMessage('error', 'Failed to connect to backend.'); }
                setIsOtpVerifying(false);
            };

            const handleStartDownload = async () => {
                 if (!selectedRank || !selectedShipType) return handleSendMessage('error', 'Rank and Ship Type are mandatory.');
                setIsDownloadLoading(true);
                setIsDownloadInProgress(true);
                setDownloadCompleted(false);
                setDownloadLog(['Starting download process...']);
                setLogFile(null);
                try {
                    if (downloadEventSourceRef.current) {
                        downloadEventSourceRef.current.close();
                    }

                    const params = new URLSearchParams({
                        rank: selectedRank,
                        shipType: selectedShipType,
                        forceRedownload: forceRedownload ? 'true' : 'false'
                    });

                    const stream = new EventSource(`${API_BASE_URL}/download_stream?${params.toString()}`);
                    downloadEventSourceRef.current = stream;

                    stream.onmessage = (event) => {
                        let data = {};
                        try {
                            data = JSON.parse(event.data);
                        } catch {
                            return;
                        }

                        if (data.type === 'started') {
                            if (data.log_file) {
                                setLogFile(data.log_file);
                            }
                            return;
                        }

                        if (data.type === 'log') {
                            setDownloadLog(prev => [...prev, data.line]);
                            return;
                        }

                        if (data.type === 'error') {
                            handleSendMessage('error', data.message || 'Download failed.');
                            setDownloadLog(prev => [...prev, `ERROR: ${data.message || 'Download failed.'}`]);
                            setIsDownloadLoading(false);
                            setIsDownloadInProgress(false);
                            stream.close();
                            downloadEventSourceRef.current = null;
                            return;
                        }

                        if (data.type === 'complete') {
                            if (data.log_file) {
                                setLogFile(data.log_file);
                            }
                            if (data.success) {
                                handleSendMessage('success', data.message || 'Download finished.');
                                setDownloadCompleted(true);
                                fetchRankFolders();
                            } else {
                                handleSendMessage('error', data.message || 'Download failed.');
                            }
                            setIsDownloadLoading(false);
                            setIsDownloadInProgress(false);
                            stream.close();
                            downloadEventSourceRef.current = null;
                        }
                    };

                    stream.onerror = () => {
                        handleSendMessage('error', 'Download stream disconnected.');
                        setDownloadLog(prev => [...prev, 'ERROR: Download stream disconnected.']);
                        setIsDownloadLoading(false);
                        setIsDownloadInProgress(false);
                        stream.close();
                        downloadEventSourceRef.current = null;
                    };
                } catch (error) {
                    handleSendMessage('error', 'Failed to connect to backend server.');
                    setDownloadLog(prev => [...prev, 'Error: Could not connect to the backend.']);
                    setIsDownloadLoading(false);
                    setIsDownloadInProgress(false);
                }
            };
            
            const handleDisconnect = async () => {
                setIsDisconnecting(true);
                try {
                    if (downloadEventSourceRef.current) {
                        downloadEventSourceRef.current.close();
                        downloadEventSourceRef.current = null;
                    }
                    await fetch(`${API_BASE_URL}/disconnect_session`, { method: 'POST' });
                    setSessionConnected(false);
                    setLoginStep('phone');
                    setPhoneNumber('');
                    setOtp('');
                    setOtpExpiresAt(null);
                    setDownloadLog([]);
                    setLogFile(null);
                    setIsDownloadInProgress(false);
                    setDownloadCompleted(false);
                    handleSendMessage('success', 'Session disconnected.');
                } catch(error) { handleSendMessage('error', 'Failed to disconnect session cleanly.'); }
                setIsDisconnecting(false);
            };

            const handleAnalyze = async () => {
                if (!selectedRankFolder) return handleSendMessage('error', 'Please select a rank folder to analyze.');
                if (!aiPrompt.trim()) return handleSendMessage('error', 'AI prompt cannot be empty.');
                
                if (eventSourceRef.current) {
                    eventSourceRef.current.close();
                }
                
                setIsAnalyzeLoading(true);
                setAnalysisResults(null);
                setSelectedFiles(new Set());
                setFeedbackNotes({});
                setVerifyStatus('idle');
                setAnalysisProgress({
                    isAnalyzing: true,
                    stage: 'connecting',
                    current: 0,
                    total: 0,
                    message: 'Connecting...',
                    liveVerified: [],
                    liveUncertain: []
                });
                
                try {
                    const url = `${API_BASE_URL}/analyze_stream?` + new URLSearchParams({
                        prompt: aiPrompt,
                        rank_folder: selectedRankFolder
                    });
                    
                    const eventSource = new EventSource(url);
                    eventSourceRef.current = eventSource;
                    
                    eventSource.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'status') {
                            setAnalysisProgress(prev => ({ ...prev, message: data.message }));
                        } else if (data.type === 'indexing_start') {
                            setAnalysisProgress(prev => ({
                                ...prev,
                                stage: 'indexing',
                                current: data.current || 0,
                                total: data.total || 0,
                                message: data.message || 'Indexing resumes...'
                            }));
                        } else if (data.type === 'indexing_progress') {
                            setAnalysisProgress(prev => ({
                                ...prev,
                                stage: 'indexing',
                                current: data.current || 0,
                                total: data.total || 0,
                                message: data.message || 'Indexing resumes...'
                            }));
                        } else if (data.type === 'indexing_complete') {
                            setAnalysisProgress(prev => ({
                                ...prev,
                                stage: 'analyzing',
                                current: 0,
                                total: 0,
                                message: data.message || 'Indexing complete. Starting AI analysis...'
                            }));
                        } else if (data.type === 'progress') {
                            setAnalysisProgress(prev => ({
                                ...prev,
                                stage: 'analyzing',
                                current: data.current,
                                total: data.total,
                                message: data.message
                            }));
                        } else if (data.type === 'match_found') {
                            setAnalysisProgress(prev => ({
                                ...prev,
                                liveVerified: [...prev.liveVerified, data.match],
                                current: data.current,
                                total: data.total
                            }));
                        } else if (data.type === 'uncertain_found') {
                            setAnalysisProgress(prev => ({
                                ...prev,
                                liveUncertain: [...prev.liveUncertain, data.match],
                                current: data.current,
                                total: data.total
                            }));
                        } else if (data.type === 'complete') {
                            setAnalysisResults({
                                success: true,
                                verified_matches: data.verified_matches || [],
                                uncertain_matches: data.uncertain_matches || [],
                                message: data.message
                            });
                            setAnalysisProgress(prev => ({ ...prev, isAnalyzing: false }));
                            setIsAnalyzeLoading(false);
                            handleSendMessage('success', data.message);
                            eventSource.close();
                        } else if (data.type === 'error') {
                            handleSendMessage('error', data.message);
                            setAnalysisProgress(prev => ({ ...prev, isAnalyzing: false }));
                            setIsAnalyzeLoading(false);
                            eventSource.close();
                        }
                    };
                    
                    eventSource.onerror = (error) => {
                        console.error('EventSource error:', error);
                        handleSendMessage('error', 'Connection to server lost.');
                        setAnalysisProgress(prev => ({ ...prev, isAnalyzing: false }));
                        setIsAnalyzeLoading(false);
                        eventSource.close();
                    };
                    
                } catch (error) {
                    console.error('Analysis error:', error);
                    handleSendMessage('error', 'Failed to connect to backend.');
                    setAnalysisProgress(prev => ({ ...prev, isAnalyzing: false }));
                    setIsAnalyzeLoading(false);
                }
            };

            const handleFeedback = async (filename, llmDecision, reason, confidence, userDecision) => {
                const notes = feedbackNotes[filename] || '';
                
                try {
                    await fetch(`${API_BASE_URL}/submit_feedback`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename,
                            query: aiPrompt,
                            llm_decision: llmDecision,
                            llm_reason: reason,
                            llm_confidence: confidence,
                            user_decision: userDecision,
                            user_notes: notes
                        })
                    });
                    
                    handleSendMessage('success', `Feedback recorded for ${filename}`);
                    
                    setAnalysisResults(prev => ({
                        ...prev,
                        uncertain_matches: prev.uncertain_matches.filter(m => m.filename !== filename),
                        verified_matches: userDecision === 'approve' 
                            ? [...prev.verified_matches, { filename, reason, confidence }]
                            : prev.verified_matches
                    }));
                } catch (error) {
                    handleSendMessage('error', 'Failed to submit feedback');
                }
            };

            const handleFileSelection = (filename) => {
                const newSelection = new Set(selectedFiles);
                if (newSelection.has(filename)) {
                    newSelection.delete(filename);
                } else {
                    newSelection.add(filename);
                }
                setSelectedFiles(newSelection);
            };
            
            const handleSelectAll = (e) => {
                if (e.target.checked) {
                    const allFilenames = new Set(analysisResults.verified_matches.map(m => m.filename));
                    setSelectedFiles(allFilenames);
                } else {
                    setSelectedFiles(new Set());
                }
            };
            
            const handleVerifyResumes = async () => {
                if (selectedFiles.size === 0) return handleSendMessage('error', 'No files selected to verify.');
                
                const fileCount = selectedFiles.size;
                setIsVerifyingResumes(true);
                setVerifyStatus('processing');
                
                try {
                    const matchData = {};
                    
                    if (analysisResults && analysisResults.verified_matches) {
                        analysisResults.verified_matches.forEach(match => {
                            if (selectedFiles.has(match.filename)) {
                                matchData[match.filename] = {
                                    reason: match.reason,
                                    confidence: match.confidence
                                };
                            }
                        });
                    }
                    
                    const response = await fetch(`${API_BASE_URL}/verify_resumes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            rank_folder: selectedRankFolder,
                            filenames: Array.from(selectedFiles),
                            match_data: matchData,
                            ai_prompt: aiPrompt
                        }),
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        setVerifyStatus('completed');
                        setReviewCompleted(true);
                        const warningText = (data.errors && data.errors.length > 0)
                            ? ` Warnings: ${data.errors.length} issue(s).`
                            : '';
                        const backendText = data.persistence_backend ? ` Backend: ${data.persistence_backend}.` : '';
                        handleSendMessage('success', ` Successfully processed ${data.processed} file(s) and updated dashboard data.${warningText}${backendText}`);
                        
                        setAnalysisResults({
                            ...analysisResults,
                            verified_matches: analysisResults.verified_matches.filter(
                                m => !selectedFiles.has(m.filename)
                            )
                        });
                        
                        setSelectedFiles(new Set());
                        fetchAvailableRanks();
                        fetchDashboardData({ resetPage: true });
                        
                        setTimeout(() => {
                            setVerifyStatus('idle');
                            setIsVerifyingResumes(false);
                        }, 2000);
                    } else {
                        const details = (data.errors && data.errors.length > 0)
                            ? ` ${data.errors.slice(0, 2).join(' | ')}`
                            : '';
                        handleSendMessage('error', (data.message || 'Failed to verify resumes.') + details);
                        setVerifyStatus('idle');
                        setIsVerifyingResumes(false);
                    }
                } catch (error) {
                    console.error('Verification error:', error);
                    handleSendMessage('error', 'Failed to connect to backend.');
                    setVerifyStatus('idle');
                    setIsVerifyingResumes(false);
                }
            };

            const getConfidenceBadge = (confidence) => {
                const percentage = Math.round(confidence * 100);
                let colorClass = 'bg-green-100 text-green-800';
                if (confidence < 0.7) colorClass = 'bg-yellow-100 text-yellow-800';
                if (confidence < 0.5) colorClass = 'bg-orange-100 text-orange-800';
                
                return (
                    <span className={`px-2 py-1 text-xs font-semibold rounded ${colorClass}`}>
                        {percentage}%
                    </span>
                );
            };
            
            const DownloadTabContent = () => {
                if (!sessionConnected) {
                    return (
                        <div>
                            <h2 className="text-2xl font-semibold mb-2">Online Resume Download</h2>
                            <p className="text-gray-600 mb-6">Connect to the website to start downloading new resumes.</p>
                            <div className="bg-gray-50 p-6 rounded-lg border">
                                {loginStep === 'phone' && (
                                    <div className="space-y-4">
                                        <div>
                                            <label htmlFor="phone" className="block text-sm font-medium text-gray-700">Registered Mobile Number</label>
                                            <input type="text" id="phone" value={phoneNumber} onChange={e => setPhoneNumber(e.target.value)} className="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="e.g. 91xxxxxxxxxx"/>
                                        </div>
                                        <button onClick={handleSendOTP} disabled={isOtpSending} className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-blue-300">
                                            {isOtpSending ? 'Connecting...' : 'Connect & Get OTP'}
                                        </button>
                                    </div>
                                )}
                                {loginStep === 'otp' && (
                                     <div className="space-y-4">
                                        <p className="text-sm text-center text-gray-600">An OTP was sent to {phoneNumber}.</p>
                                        {otpSecondsLeft !== null && (
                                            <p className={`text-xs text-center ${otpSecondsLeft <= 30 ? 'text-red-600' : 'text-gray-500'}`}>
                                                OTP expires in {otpSecondsLeft}s
                                            </p>
                                        )}
                                        <div>
                                            <label htmlFor="otp" className="block text-sm font-medium text-gray-700">Enter OTP</label>
                                            <input type="text" key="otp-input" id="otp" value={otp} onChange={e => setOtp(e.target.value)} className="mt-1 w-full p-2 border border-gray-300 rounded-md"/>
                                        </div>
                                        <button onClick={handleVerifyOTP} disabled={isOtpVerifying} className="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 disabled:bg-green-300">
                                            {isOtpVerifying ? 'Verifying...' : 'Verify & Start Session'}
                                        </button>
                                         <button onClick={() => { setLoginStep('phone'); setOtp(''); setOtpExpiresAt(null); }} className="w-full text-sm text-center text-blue-600 hover:underline">
                                            Use a different number
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                }

                return (
                    <div>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-semibold">Download Resumes</h2>
                            <div className="flex items-center space-x-4">
                                <div className="flex items-center space-x-2">
                                    <span className="relative flex h-3 w-3"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span>
                                    <span className="text-sm font-medium text-green-700">Connected to Website</span>
                                </div>
                                <button onClick={handleDisconnect} disabled={isDisconnecting} className="text-sm text-red-600 hover:underline disabled:text-gray-400">{isDisconnecting ? 'Disconnecting...' : 'Disconnect'}</button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="space-y-6">
                                <div>
                                    <label htmlFor="rank" className="block text-sm font-medium text-gray-700 mb-1">Select Rank</label>
                                    <select id="rank" value={selectedRank} onChange={e => setSelectedRank(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                        {ranks.map(r => <option key={r} value={r}>{r}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label htmlFor="shipType" className="block text-sm font-medium text-gray-700 mb-1">Select Ship Type</label>
                                    <select id="shipType" value={selectedShipType} onChange={e => setSelectedShipType(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                        {shipTypes.map(st => <option key={st} value={st}>{st}</option>)}
                                    </select>
                                </div>
                                <div className="flex items-center">
                                    <input id="force" type="checkbox" checked={forceRedownload} onChange={e => setForceRedownload(e.target.checked)} className="h-4 w-4 text-blue-600 border-gray-300 rounded"/>
                                    <label htmlFor="force" className="ml-2 block text-sm text-gray-900">Force re-download all resumes (slower)</label>
                                </div>
                                <button onClick={handleStartDownload} disabled={isDownloadLoading} className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-blue-300">
                                    {isDownloadLoading ? 'Downloading...' : 'Start Download'}
                                </button>
                                {isDownloadInProgress && (
                                    <div className="rounded-lg border border-blue-200 bg-blue-50 p-4">
                                        <div className="flex items-center justify-between mb-3">
                                            <div className="flex items-center space-x-2">
                                                <svg className="animate-spin h-5 w-5 text-blue-700" viewBox="0 0 24 24" fill="none">
                                                    <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="3" className="opacity-25"></circle>
                                                    <path d="M22 12a10 10 0 00-10-10" stroke="currentColor" strokeWidth="3" className="opacity-90"></path>
                                                </svg>
                                                <span className="text-sm font-semibold text-blue-800">Download in progress</span>
                                            </div>
                                            <span className="text-xs text-blue-700">Elapsed: {downloadElapsedSeconds}s</span>
                                        </div>
                                        <div className="h-2 rounded bg-blue-100 download-indeterminate"></div>
                                        <p className="text-xs text-blue-700 mt-2">The scraper is collecting profiles and generating PDFs. This may take a few minutes.</p>
                                    </div>
                                )}
                            </div>
                            <div>
                                <h3 className="text-lg font-medium text-gray-800 mb-2">Download Log</h3>
                                <div className="bg-gray-800 text-white font-mono text-sm p-4 rounded-lg log-area overflow-y-auto" role="log" aria-live="polite" aria-label="Download progress log">
                                    {downloadLog.map((line, i) => <p key={i} className="whitespace-pre-wrap">{line}</p>)}
                                </div>
                                {logFile && (
                                    <p className="text-center text-sm text-green-700 mt-2">
                                        Full log saved to: <span className="font-mono">{logFile}</span>
                                    </p>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };
            
            const DashboardTabContent = () => {
                const totalSelectable = filteredData.length;
                const selectedInFiltered = filteredData.filter(row => selectedDashboardIds.has(String(row.candidate_id))).length;
                const allSelected = totalSelectable > 0 && selectedInFiltered === totalSelectable;
                const drawerCandidate = dashboardData.find(row => String(row.candidate_id) === drawerCandidateId) || null;
                const paginatedRows = getPaginatedData();

                return (
                    <div>
                        <h2 className="text-2xl font-semibold mb-6">Verified Candidates Dashboard</h2>
                        
                        {/* View Selector */}
                        <div className="mb-6 flex items-center space-x-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">View</label>
                                <select 
                                    value={dashboardView} 
                                    onChange={e => setDashboardView(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-md"
                                >
                                    <option value="master">All Candidates (Master)</option>
                                    <option value="rank">By Rank</option>
                                </select>
                            </div>
                            
                            {dashboardView === 'rank' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Select Rank</label>
                                    <select 
                                        value={dashboardRank} 
                                        onChange={e => setDashboardRank(e.target.value)}
                                        className="p-2 border border-gray-300 rounded-md"
                                    >
                                        {availableRanks.map(rank => (
                                            <option key={rank.rank} value={rank.rank}>
                                                {rank.display_name} ({rank.count})
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}
                            
                            <button 
                                onClick={() => fetchDashboardData({ preserveScroll: true })}
                                className="mt-6 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
                            >
                                Refresh
                            </button>
                            <button
                                onClick={handleExportResumes}
                                disabled={selectedDashboardIds.size === 0 || isExporting}
                                className="mt-6 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:bg-gray-400"
                            >
                                {isExporting ? 'Exporting...' : `Export Selected (${selectedDashboardIds.size})`}
                            </button>
                        </div>
                        
                        {/* Search Bar */}
                        <div className="mb-4">
                            <input
                                type="text"
                                placeholder="Search by name, email, country, rank, or match reason..."
                                value={searchQuery}
                                onChange={e => setSearchQuery(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-md"
                            />
                            {searchQuery && (
                                <p className="text-sm text-gray-600 mt-2">
                                    Showing {filteredData.length} of {dashboardData.length} results
                                </p>
                            )}
                        </div>

                        {selectedDashboardIds.size > 0 && (
                            <div className="sticky top-0 z-20 mb-4 border border-blue-200 bg-blue-50 rounded-lg px-4 py-3 flex flex-wrap items-center justify-between gap-3">
                                <p className="text-sm font-medium text-blue-800">
                                    {selectedDashboardIds.size} candidate(s) selected
                                </p>
                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={() => setSelectedDashboardIds(new Set())}
                                        className="px-3 py-1.5 text-sm border border-blue-300 rounded-md text-blue-700 hover:bg-blue-100"
                                    >
                                        Clear Selection
                                    </button>
                                    <button
                                        onClick={handleExportResumes}
                                        disabled={isExporting}
                                        className="px-3 py-1.5 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400"
                                    >
                                        {isExporting ? 'Exporting...' : 'Export Selected'}
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        {/* Loading State */}
                        {isDashboardLoading && (
                            <div className="text-center py-8">
                                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                <p className="mt-2 text-gray-600">Loading dashboard data...</p>
                            </div>
                        )}
                        
                        {/* Empty State */}
                        {!isDashboardLoading && dashboardData.length === 0 && (
                            <div className="text-center py-12 bg-gray-50 rounded-lg">
                                <p className="text-gray-600 mb-2">No verified candidates yet.</p>
                                <p className="text-sm text-gray-500">Use AI Search to find and verify candidates.</p>
                            </div>
                        )}
                        
                        {/* Data Table */}
                        {!isDashboardLoading && dashboardData.length > 0 && (
                            <div>
                                <div className="bg-white border border-gray-200 rounded-lg overflow-hidden">
                                    <div ref={dashboardTableScrollRef} className="overflow-x-auto" style={{maxHeight: '600px'}}>
                                        <table className="min-w-full divide-y divide-gray-200 dashboard-table">
                                            <thead>
                                                <tr>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        <input
                                                            type="checkbox"
                                                            checked={allSelected}
                                                            onChange={(e) => handleDashboardSelectAll(e.target.checked)}
                                                            aria-label="Select all candidates in filtered results"
                                                        />
                                                    </th>
                                                    <th 
                                                        onClick={() => handleSort('filename')}
                                                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
                                                    >
                                                        Filename {sortColumn === 'filename' && (sortOrder === 'asc' ? '' : '')}
                                                    </th>
                                                    <th 
                                                        onClick={() => handleSort('date_added')}
                                                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
                                                    >
                                                        Date Added {sortColumn === 'date_added' && (sortOrder === 'asc' ? '' : '')}
                                                    </th>
                                                    <th 
                                                        onClick={() => handleSort('name')}
                                                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
                                                    >
                                                        Name {sortColumn === 'name' && (sortOrder === 'asc' ? '' : '')}
                                                    </th>
                                                    <th 
                                                        onClick={() => handleSort('present_rank')}
                                                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
                                                    >
                                                        Rank {sortColumn === 'present_rank' && (sortOrder === 'asc' ? '' : '')}
                                                    </th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Email
                                                    </th>
                                                    <th 
                                                        onClick={() => handleSort('country')}
                                                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200"
                                                    >
                                                        Country {sortColumn === 'country' && (sortOrder === 'asc' ? '' : '')}
                                                    </th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Mobile
                                                    </th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Match Reason
                                                    </th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Status
                                                    </th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Notes
                                                    </th>
                                                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Actions
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {paginatedRows.map((row, idx) => (
                                                    <tr key={idx} className="hover:bg-gray-50">
                                                        <td className="px-4 py-3 whitespace-nowrap">
                                                            <input
                                                                type="checkbox"
                                                                checked={selectedDashboardIds.has(String(row.candidate_id))}
                                                                onChange={() => handleDashboardRowSelect(row.candidate_id)}
                                                                aria-label={`Select candidate ${row.candidate_id}`}
                                                            />
                                                        </td>
                                                        <td className="px-4 py-3 whitespace-nowrap">
                                                            <a 
                                                                href={row.resume_url} 
                                                                target="_blank" 
                                                                rel="noopener noreferrer"
                                                                className="text-blue-600 hover:underline"
                                                            >
                                                                {row.filename}
                                                            </a>
                                                        </td>
                                                        <td className="px-4 py-3 whitespace-nowrap text-gray-600">
                                                            {formatDate(row.date_added)}
                                                        </td>
                                                        <td className="px-4 py-3 whitespace-nowrap font-medium">
                                                            {row.name}
                                                        </td>
                                                        <td className="px-4 py-3 whitespace-nowrap">
                                                            {row.present_rank}
                                                        </td>
                                                        <td className="px-4 py-3 whitespace-nowrap text-gray-600">
                                                            {row.email}
                                                        </td>
                                                        <td className="px-4 py-3 whitespace-nowrap">
                                                            {row.country}
                                                        </td>
                                                        <td className="px-4 py-3 whitespace-nowrap text-gray-600">
                                                            {row.mobile_no}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <div className="truncate-reason" title={row.ai_match_reason}>
                                                                {row.ai_match_reason}
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-3 whitespace-nowrap">
                                                            <select
                                                                value={row.status || 'New'}
                                                                onChange={(e) => handleDashboardStatusChange(row.candidate_id, e.target.value)}
                                                                className="p-1 border border-gray-300 rounded text-sm"
                                                            >
                                                                {STATUS_OPTIONS.map(status => (
                                                                    <option key={status} value={status}>{status}</option>
                                                                ))}
                                                            </select>
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <div className="text-xs text-gray-600 mb-1 truncate-reason" title={row.notes || ''}>
                                                                {row.notes || 'No notes'}
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-3 whitespace-nowrap">
                                                            <div className="flex flex-col space-y-2">
                                                                <button
                                                                    onClick={() => openDashboardDrawer(row.candidate_id)}
                                                                    className="bg-blue-600 text-white text-xs px-2 py-1 rounded hover:bg-blue-700"
                                                                    aria-label={`Open details for candidate ${row.candidate_id}`}
                                                                >
                                                                    Details
                                                                </button>
                                                                <button
                                                                    onClick={() => handleOpenHistory(row.candidate_id)}
                                                                    className="bg-gray-600 text-white text-xs px-2 py-1 rounded hover:bg-gray-700"
                                                                >
                                                                    View History
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                {/* Pagination */}
                                {totalPages > 1 && (
                                    <div className="mt-4 flex items-center justify-between">
                                        <div className="text-sm text-gray-600">
                                            Showing {((currentPage - 1) * rowsPerPage) + 1} to {Math.min(currentPage * rowsPerPage, filteredData.length)} of {filteredData.length} results
                                        </div>
                                        <div className="flex space-x-2">
                                            <button
                                                onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                                                disabled={currentPage === 1}
                                                className="px-3 py-1 border border-gray-300 rounded disabled:opacity-50 hover:bg-gray-100"
                                            >
                                                Previous
                                            </button>
                                            {[...Array(Math.min(5, totalPages))].map((_, idx) => {
                                                let pageNum;
                                                if (totalPages <= 5) {
                                                    pageNum = idx + 1;
                                                } else if (currentPage <= 3) {
                                                    pageNum = idx + 1;
                                                } else if (currentPage >= totalPages - 2) {
                                                    pageNum = totalPages - 4 + idx;
                                                } else {
                                                    pageNum = currentPage - 2 + idx;
                                                }
                                                
                                                return (
                                                    <button
                                                        key={idx}
                                                        onClick={() => setCurrentPage(pageNum)}
                                                        className={`px-3 py-1 border rounded ${currentPage === pageNum ? 'bg-blue-600 text-white border-blue-600' : 'border-gray-300 hover:bg-gray-100'}`}
                                                    >
                                                        {pageNum}
                                                    </button>
                                                );
                                            })}
                                            <button
                                                onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                                                disabled={currentPage === totalPages}
                                                className="px-3 py-1 border border-gray-300 rounded disabled:opacity-50 hover:bg-gray-100"
                                            >
                                                Next
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {isDashboardDrawerOpen && drawerCandidate && (
                            <div className="fixed inset-0 z-40 flex justify-end">
                                <div className="absolute inset-0 bg-black/30" onClick={closeDashboardDrawer}></div>
                                <div className="relative h-full w-full max-w-md bg-white shadow-2xl border-l border-gray-200 p-5 overflow-y-auto" role="dialog" aria-modal="true" aria-label="Candidate details panel">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-semibold text-gray-900">Candidate Details</h3>
                                        <button onClick={closeDashboardDrawer} className="text-sm text-gray-500 hover:text-gray-800">Close</button>
                                    </div>

                                    <div className="space-y-4 text-sm">
                                        <div>
                                            <p className="text-xs uppercase text-gray-500">Name</p>
                                            <p className="font-medium">{drawerCandidate.name || '-'}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs uppercase text-gray-500">Candidate ID</p>
                                            <p className="font-medium">{drawerCandidate.candidate_id || '-'}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs uppercase text-gray-500">Resume</p>
                                            <a href={drawerCandidate.resume_url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline break-all">
                                                {drawerCandidate.filename}
                                            </a>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <p className="text-xs uppercase text-gray-500">Present Rank</p>
                                                <p>{drawerCandidate.present_rank || '-'}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs uppercase text-gray-500">Country</p>
                                                <p>{drawerCandidate.country || '-'}</p>
                                            </div>
                                        </div>
                                        <div>
                                            <p className="text-xs uppercase text-gray-500">Match Reason</p>
                                            <p className="text-gray-700">{drawerCandidate.ai_match_reason || '-'}</p>
                                        </div>

                                        <div>
                                            <label className="block text-xs uppercase text-gray-500 mb-1">Status</label>
                                            <select
                                                value={drawerCandidate.status || 'New'}
                                                onChange={(e) => handleDashboardStatusChange(drawerCandidate.candidate_id, e.target.value)}
                                                className="w-full p-2 border border-gray-300 rounded text-sm"
                                            >
                                                {STATUS_OPTIONS.map(status => (
                                                    <option key={status} value={status}>{status}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-xs uppercase text-gray-500 mb-1">Add Note</label>
                                            <textarea
                                                key={`drawer-note-${drawerCandidate.candidate_id}`}
                                                ref={drawerNoteInputRef}
                                                rows="4"
                                                defaultValue={drawerNoteSeed}
                                                placeholder="Write note for this candidate..."
                                                className="w-full p-2 border border-gray-300 rounded text-sm"
                                            />
                                            <button
                                                onClick={() => handleDashboardAddNotes(
                                                    drawerCandidate.candidate_id,
                                                    drawerNoteInputRef.current ? drawerNoteInputRef.current.value : ''
                                                )}
                                                className="mt-2 w-full bg-blue-600 text-white text-sm py-2 rounded-md hover:bg-blue-700"
                                            >
                                                Save Note
                                            </button>
                                        </div>

                                        <button
                                            onClick={() => handleOpenHistory(drawerCandidate.candidate_id)}
                                            className="w-full bg-gray-700 text-white text-sm py-2 rounded-md hover:bg-gray-800"
                                        >
                                            View Full History
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const SettingsTabContent = () => {
                const setField = (key, value) => setSettingsForm(prev => ({ ...prev, [key]: value }));
                const sectionButtonClass = (id) => `px-4 py-2 text-sm font-medium rounded-md border ${settingsSection === id ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'}`;

                return (
                    <div>
                        <h2 className="text-2xl font-semibold mb-6">Admin Settings</h2>
                        {!settingsLoaded ? (
                            <div className="max-w-lg bg-gray-50 border border-gray-200 rounded-lg p-5">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Admin Password</label>
                                <input
                                    type="password"
                                    ref={adminPasswordInputRef}
                                    defaultValue=""
                                    placeholder="Enter admin password"
                                    className="w-full p-2 border border-gray-300 rounded-md"
                                />
                                <button
                                    onClick={loadAdminSettings}
                                    disabled={isSettingsLoading}
                                    className="mt-3 w-full bg-blue-600 text-white font-medium py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400"
                                >
                                    {isSettingsLoading ? 'Loading...' : 'Load Settings'}
                                </button>
                                <p className="text-xs text-gray-500 mt-2">Secrets are masked and never returned in full.</p>
                            </div>
                        ) : (
                            <div className="space-y-5">
                                <div className="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3">
                                    <p className="text-sm text-green-900">Authenticated as admin</p>
                                    <button
                                        onClick={() => {
                                            setSettingsLoaded(false);
                                            setAdminSessionPassword('');
                                            if (adminPasswordInputRef.current) {
                                                adminPasswordInputRef.current.value = '';
                                            }
                                            setSettingsSection('runtime');
                                            setAdminPasswordForm({ current_password: '', new_password: '', confirm_password: '' });
                                        }}
                                        className="text-sm text-green-800 hover:underline"
                                    >
                                        Switch Admin
                                    </button>
                                </div>

                                <div className="flex flex-wrap gap-2">
                                    <button className={sectionButtonClass('runtime')} onClick={() => setSettingsSection('runtime')}>Runtime Flags</button>
                                    <button className={sectionButtonClass('operational')} onClick={() => setSettingsSection('operational')}>Operational Settings</button>
                                    <button className={sectionButtonClass('secrets')} onClick={() => setSettingsSection('secrets')}>Secrets</button>
                                    <button className={sectionButtonClass('admin_password')} onClick={() => setSettingsSection('admin_password')}>Admin Password</button>
                                    <button className={sectionButtonClass('readme')} onClick={() => setSettingsSection('readme')}>README</button>
                                </div>

                                {settingsSection === 'runtime' && (
                                    <div className="bg-white border border-gray-200 rounded-lg p-4 space-y-3">
                                        <h3 className="font-semibold text-gray-900">Runtime Flags</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                            {[
                                                ['use_supabase_db', 'Use Supabase DB'],
                                                ['use_dual_write', 'Use Dual Write'],
                                                ['use_supabase_reads', 'Use Supabase Reads'],
                                                ['use_local_agent', 'Use Local Agent'],
                                                ['use_cloud_export', 'Use Cloud Export'],
                                            ].map(([key, label]) => (
                                                <label key={key} className="flex items-center space-x-2">
                                                    <input
                                                        type="checkbox"
                                                        checked={Boolean(settingsForm[key])}
                                                        onChange={e => setField(key, e.target.checked)}
                                                    />
                                                    <span>{label}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {settingsSection === 'operational' && (
                                    <div className="bg-white border border-gray-200 rounded-lg p-4 space-y-4">
                                        <h3 className="font-semibold text-gray-900">Operational Settings</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Default Download Folder</label>
                                                <div className="flex gap-2">
                                                    <input value={settingsForm.default_download_folder} onChange={e => setField('default_download_folder', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                                    <button type="button" onClick={() => openFolderPicker('default_download_folder')} className="px-3 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50">Browse</button>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Verified Resumes Folder</label>
                                                <div className="flex gap-2">
                                                    <input value={settingsForm.verified_resumes_folder} onChange={e => setField('verified_resumes_folder', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                                    <button type="button" onClick={() => openFolderPicker('verified_resumes_folder')} className="px-3 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50">Browse</button>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Supabase URL</label>
                                                <input value={settingsForm.supabase_url} onChange={e => setField('supabase_url', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">SeaJob Login URL</label>
                                                <input value={settingsForm.seajob_login_url} onChange={e => setField('seajob_login_url', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">SeaJob Dashboard URL</label>
                                                <input value={settingsForm.seajob_dashboard_url} onChange={e => setField('seajob_dashboard_url', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">OTP Window Seconds</label>
                                                <input value={settingsForm.otp_window_seconds} onChange={e => setField('otp_window_seconds', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Registry DB Path</label>
                                                <input value={settingsForm.registry_db_path} onChange={e => setField('registry_db_path', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Feedback DB Path</label>
                                                <input value={settingsForm.feedback_db_path} onChange={e => setField('feedback_db_path', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Log Directory</label>
                                                <input value={settingsForm.log_dir} onChange={e => setField('log_dir', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Pinecone Environment</label>
                                                <input value={settingsForm.pinecone_environment} onChange={e => setField('pinecone_environment', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Pinecone Index Name</label>
                                                <input value={settingsForm.pinecone_index_name} onChange={e => setField('pinecone_index_name', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Embedding Model Name</label>
                                                <input value={settingsForm.embedding_model_name} onChange={e => setField('embedding_model_name', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Reasoning Model Name</label>
                                                <input value={settingsForm.reasoning_model_name} onChange={e => setField('reasoning_model_name', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Minimum Similarity Score</label>
                                                <input value={settingsForm.min_similarity_score} onChange={e => setField('min_similarity_score', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                            </div>
                                        </div>
                                        <button onClick={testSupabaseSettings} disabled={isSettingsSaving} className="bg-slate-700 text-white px-4 py-2 rounded-md hover:bg-slate-800 disabled:bg-gray-400">
                                            Test Supabase
                                        </button>
                                    </div>
                                )}

                                {settingsSection === 'secrets' && (
                                    <div className="bg-white border border-gray-200 rounded-lg p-4 space-y-4">
                                        <h3 className="font-semibold text-gray-900">Secrets (Admin Only)</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">SeaJobs Username</label>
                                                <input type="text" value={settingsForm.seajob_username} onChange={e => setField('seajob_username', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" placeholder={`Current: ${settingsMasks.seajob_username.preview || 'not set'}`} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">SeaJobs Password</label>
                                                <input type="password" value={settingsForm.seajob_password} onChange={e => setField('seajob_password', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" placeholder={`Current: ${settingsMasks.seajob_password.preview || 'not set'}`} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                                                <input type="password" value={settingsForm.gemini_api_key} onChange={e => setField('gemini_api_key', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" placeholder={`Current: ${settingsMasks.gemini_api_key.preview || 'not set'}`} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Pinecone API Key</label>
                                                <input type="password" value={settingsForm.pinecone_api_key} onChange={e => setField('pinecone_api_key', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" placeholder={`Current: ${settingsMasks.pinecone_api_key.preview || 'not set'}`} />
                                            </div>
                                            <div className="md:col-span-2">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Supabase Secret Key</label>
                                                <input type="password" value={settingsForm.supabase_secret_key} onChange={e => setField('supabase_secret_key', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" placeholder={`Current: ${settingsMasks.supabase_secret_key.preview || 'not set'}`} />
                                            </div>
                                        </div>
                                        <p className="text-xs text-gray-500">Leave secret fields blank to keep existing values.</p>
                                    </div>
                                )}

                                {settingsSection === 'admin_password' && (
                                    <div className="bg-white border border-gray-200 rounded-lg p-4 space-y-4">
                                        <h3 className="font-semibold text-gray-900">Change Admin Password</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="md:col-span-2">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Current Admin Password</label>
                                                <input
                                                    type="password"
                                                    value={adminPasswordForm.current_password}
                                                    onChange={e => setAdminPasswordForm(prev => ({ ...prev, current_password: e.target.value }))}
                                                    className="w-full p-2 border border-gray-300 rounded-md"
                                                    placeholder="Enter current admin password"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">New Admin Password</label>
                                                <input
                                                    type="password"
                                                    value={adminPasswordForm.new_password}
                                                    onChange={e => setAdminPasswordForm(prev => ({ ...prev, new_password: e.target.value }))}
                                                    className="w-full p-2 border border-gray-300 rounded-md"
                                                    placeholder="At least 8 characters"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                                                <input
                                                    type="password"
                                                    value={adminPasswordForm.confirm_password}
                                                    onChange={e => setAdminPasswordForm(prev => ({ ...prev, confirm_password: e.target.value }))}
                                                    className="w-full p-2 border border-gray-300 rounded-md"
                                                    placeholder="Re-enter new password"
                                                />
                                            </div>
                                        </div>
                                        <div className="flex flex-wrap gap-3">
                                            <button onClick={generateAdminPassword} type="button" className="bg-slate-700 text-white px-4 py-2 rounded-md hover:bg-slate-800">
                                                Generate Password
                                            </button>
                                            <button onClick={changeAdminPassword} disabled={isSettingsSaving} className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400">
                                                {isSettingsSaving ? 'Updating...' : 'Update Admin Password'}
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {settingsSection === 'readme' && (
                                    <div className="bg-white border border-gray-200 rounded-lg p-5 space-y-4 text-sm text-gray-700">
                                        <h3 className="font-semibold text-gray-900 text-base">Settings README</h3>
                                        <p>
                                            This page documents each setting, where to find its value, and how to reset it.
                                        </p>

                                        <div>
                                            <p className="font-semibold text-gray-900">Runtime Flags</p>
                                            <p>`use_supabase_db`: Enables Supabase repository mode. Source: your deployment/runtime mode decision. Reset: set to `false` to return to CSV-only.</p>
                                            <p>`use_dual_write`: Writes to CSV + Supabase together. Source: migration rollout strategy. Reset: set `false` for single backend mode.</p>
                                            <p>`use_supabase_reads`: Reads dashboard/history from Supabase. Source: migration phase status. Reset: set `false` to read from CSV.</p>
                                            <p>`use_local_agent`: Reserved for hybrid cloud/local-agent rollout. Reset: set `false` for current architecture.</p>
                                            <p>`use_cloud_export`: Reserved for cloud export mode. Reset: set `false` for local export behavior.</p>
                                        </div>

                                        <div>
                                            <p className="font-semibold text-gray-900">Operational Settings</p>
                                            <p>`default_download_folder`: Folder where downloaded resumes are stored. Source: local machine directory path chosen by admin. Reset: choose a new folder via Browse.</p>
                                            <p>`verified_resumes_folder`: Folder where verification CSV/event data is stored. Source: local path or project-relative folder. Reset: set to `Verified_Resumes` or browse a new folder.</p>
                                            <p>`supabase_url`: Your Supabase project URL (`https://&lt;project-ref&gt;.supabase.co`). Source: Supabase dashboard project URL.</p>
                                            <p>`seajob_login_url`: SeaJob login URL used by scraper. Default should remain `http://seajob.net/seajob_login.php` unless SeaJob changes.</p>
                                            <p>`seajob_dashboard_url`: SeaJob dashboard URL used post-login. Default should remain `http://seajob.net/company/dashboard.php` unless SeaJob changes.</p>
                                            <p>`otp_window_seconds`: Allowed OTP entry window before considering session invalid. Source: observed SeaJob OTP behavior. Reset: recommended 120.</p>
                                            <p>`registry_db_path`: SQLite path for analyzer file-index registry. Reset: `registry.db`.</p>
                                            <p>`feedback_db_path`: SQLite path for feedback-learning events. Reset: `feedback.db`.</p>
                                            <p>`log_dir`: Directory where download session logs are written. Reset: `logs`.</p>
                                            <p>`pinecone_environment`: Pinecone deployment environment/region (for your selected SDK pattern). Source: Pinecone project settings.</p>
                                            <p>`pinecone_index_name`: Pinecone index name used for vector retrieval. Source: Pinecone index list.</p>
                                            <p>`embedding_model_name`: Embedding model used for retrieval vectors. Source: model provider docs/availability.</p>
                                            <p>`reasoning_model_name`: Model used for candidate reasoning/scoring. Source: model provider docs/availability.</p>
                                            <p>`min_similarity_score`: Retrieval threshold (`0.0` to `1.0`). Reset: `0.25` baseline.</p>
                                        </div>

                                        <div>
                                            <p className="font-semibold text-gray-900">Secrets</p>
                                            <p>`seajob_username`, `seajob_password`: SeaJob company login credentials. Source: SeaJob admin account owner.</p>
                                            <p>`gemini_api_key`: Google AI API key. Source: Google AI Studio / Cloud console key management.</p>
                                            <p>`pinecone_api_key`: Pinecone API key. Source: Pinecone console API keys.</p>
                                            <p>`supabase_secret_key`: Supabase secret API key (`sb_secret...`). Source: Supabase Settings -> API Keys.</p>
                                            <p>Reset approach for secrets: generate/rotate in provider console, then update here and click Save & Apply.</p>
                                        </div>

                                        <div>
                                            <p className="font-semibold text-gray-900">Admin Password</p>
                                            <p>Use the Admin Password tab to set a new password manually or generate a strong password. After update, re-auth with the new password.</p>
                                        </div>
                                    </div>
                                )}

                                <div className="flex flex-wrap gap-3">
                                    <button onClick={saveAdminSettings} disabled={isSettingsSaving} className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:bg-gray-400">
                                        {isSettingsSaving ? 'Saving...' : 'Save & Apply'}
                                    </button>
                                </div>

                                {folderPicker.open && (
                                    <div className="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
                                        <div className="bg-white w-full max-w-2xl rounded-lg border border-gray-200 shadow-xl">
                                            <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                                                <h4 className="font-semibold text-gray-900">Select Folder</h4>
                                                <button
                                                    className="text-sm text-gray-500 hover:text-gray-800"
                                                    onClick={() => setFolderPicker({ open: false, targetKey: '', currentPath: '', parentPath: '', entries: [], loading: false })}
                                                >
                                                    Close
                                                </button>
                                            </div>
                                            <div className="px-4 py-3 border-b border-gray-100 text-sm text-gray-700 break-all">
                                                Current: {folderPicker.currentPath || '-'}
                                            </div>
                                            <div className="max-h-72 overflow-y-auto p-3 space-y-2">
                                                {folderPicker.loading && <p className="text-sm text-gray-500">Loading folders...</p>}
                                                {!folderPicker.loading && (
                                                    <>
                                                        {folderPicker.parentPath && (
                                                            <button
                                                                type="button"
                                                                className="w-full text-left px-3 py-2 rounded-md border border-gray-200 hover:bg-gray-50"
                                                                onClick={() => loadFolderPickerPath(folderPicker.parentPath, folderPicker.targetKey)}
                                                            >
                                                                .. (Parent Directory)
                                                            </button>
                                                        )}
                                                        {folderPicker.entries.map((entry) => (
                                                            <button
                                                                key={entry.path}
                                                                type="button"
                                                                className="w-full text-left px-3 py-2 rounded-md border border-gray-200 hover:bg-gray-50"
                                                                onClick={() => loadFolderPickerPath(entry.path, folderPicker.targetKey)}
                                                            >
                                                                {entry.name}
                                                            </button>
                                                        ))}
                                                        {folderPicker.entries.length === 0 && !folderPicker.parentPath && (
                                                            <p className="text-sm text-gray-500">No subfolders found.</p>
                                                        )}
                                                    </>
                                                )}
                                            </div>
                                            <div className="px-4 py-3 border-t border-gray-200 flex items-center justify-end gap-2">
                                                <button
                                                    type="button"
                                                    className="px-3 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50"
                                                    onClick={() => setFolderPicker({ open: false, targetKey: '', currentPath: '', parentPath: '', entries: [], loading: false })}
                                                >
                                                    Cancel
                                                </button>
                                                <button
                                                    type="button"
                                                    className="px-3 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700"
                                                    onClick={selectFolderFromPicker}
                                                >
                                                    Use This Folder
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                );
            };
            
            return (
                <>
                <div className="min-h-screen p-8 bg-gray-50 text-gray-800">
                    <div className="max-w-7xl mx-auto">
                        <header className="flex justify-between items-center mb-8">
                             <div className="flex items-center gap-4">
                                <img
                                    src={`${API_BASE_URL}/app_asset/Truncated_Njord_logo.jpg`}
                                    alt="Njord logo"
                                    className="h-14 w-auto object-contain rounded"
                                    onError={(e) => { e.currentTarget.style.display = 'none'; }}
                                />
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900 leading-tight">NjordHR</h1>
                                    <p className="text-xs text-gray-500 mt-1">Multi-Stage Retrieval + CSV Export + Dashboard</p>
                                </div>
                             </div>
                            <div className="text-sm text-gray-500">Phase 1: Core Engine</div>
                        </header>
                        <div className="mb-6 bg-white border border-gray-200 rounded-xl p-4">
                            <p className="text-xs font-semibold uppercase tracking-wide text-gray-500 mb-3">Workflow</p>
                            <div className="grid grid-cols-1 md:grid-cols-5 gap-3">
                                {WORKFLOW_STEPS.map((step, index) => {
                                    const isDone = workflowState[step];
                                    const isCurrent = currentWorkflowStep === step;
                                    return (
                                        <div key={step} className={`rounded-lg border px-3 py-2 ${isDone ? 'border-green-300 bg-green-50' : isCurrent ? 'border-blue-300 bg-blue-50' : 'border-gray-200 bg-gray-50'}`}>
                                            <div className="flex items-center justify-between">
                                                <span className="text-xs text-gray-500">Step {index + 1}</span>
                                                <span className={`text-xs font-semibold ${isDone ? 'text-green-700' : isCurrent ? 'text-blue-700' : 'text-gray-500'}`}>
                                                    {isDone ? 'Done' : isCurrent ? 'Current' : 'Pending'}
                                                </span>
                                            </div>
                                            <p className={`mt-1 font-semibold ${isDone ? 'text-green-800' : isCurrent ? 'text-blue-800' : 'text-gray-700'}`}>{step}</p>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="flex border-b border-gray-300 mb-6">
                            <button onClick={() => setActiveTab('download')} className={`px-6 py-3 text-lg font-medium border-b-2 transition ${activeTab === 'download' ? 'tab-active' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Download</button>
                            <button onClick={() => setActiveTab('search')} className={`px-6 py-3 text-lg font-medium border-b-2 transition ${activeTab === 'search' ? 'tab-active' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>AI Search</button>
                            <button onClick={() => setActiveTab('dashboard')} className={`px-6 py-3 text-lg font-medium border-b-2 transition ${activeTab === 'dashboard' ? 'tab-active' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Dashboard</button>
                            <button onClick={() => setActiveTab('settings')} className={`px-6 py-3 text-lg font-medium border-b-2 transition ${activeTab === 'settings' ? 'tab-active' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Settings</button>
                        </div>
                        <main className="bg-white p-8 rounded-xl shadow-lg">
                             {activeTab === 'download' && <DownloadTabContent />}
                             {activeTab === 'search' && (
                                <div>
                                    <h2 className="text-2xl font-semibold mb-6">AI Search</h2>
                                    <div className="space-y-6">
                                        <div>
                                            <label htmlFor="rankFolder" className="block text-sm font-medium text-gray-700 mb-1">Select Rank Folder to Analyze</label>
                                            <select 
                                                id="rankFolder" 
                                                value={selectedRankFolder} 
                                                onChange={e => setSelectedRankFolder(e.target.value)} 
                                                className="w-full p-2 border border-gray-300 rounded-md shadow-sm"
                                                disabled={rankFolders.length === 0}
                                            >
                                                {rankFolders.length > 0 ? (
                                                    rankFolders.map(folder => <option key={folder} value={folder}>{folder.replace(/_/g, ' ')}</option>)
                                                ) : (
                                                    <option>No downloaded resume folders found</option>
                                                )}
                                            </select>
                                        </div>
                                        <div>
                                            <label htmlFor="prompt" className="block text-sm font-medium text-gray-700 mb-1">Enter AI Search Prompt</label>
                                            <textarea id="prompt" rows="4" value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., Having a valid US visa and oil tanker experience"></textarea>
                                        </div>
                                        <button onClick={handleAnalyze} disabled={isAnalyzeLoading || sessionConnected || analysisProgress.isAnalyzing} className="bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition">
                                            {isAnalyzeLoading || analysisProgress.isAnalyzing ? 'Analyzing...' : 'Analyze Resumes'}
                                        </button>
                                        {sessionConnected && <p className="text-xs text-gray-500">Note: AI Search is disabled while a download session is active.</p>}
                                    </div>
                                    
                                    {analysisProgress.isAnalyzing && (
                                        <div className="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
                                            <div className="flex items-center justify-between mb-4">
                                                <h3 className="text-lg font-semibold text-blue-900"> Analysis in Progress</h3>
                                                <span className="text-sm text-blue-700 animate-pulse-slow">
                                                    {analysisProgress.current}/{analysisProgress.total} processed
                                                </span>
                                            </div>

                                            <div className="mb-4 flex items-center justify-between text-xs font-medium">
                                                <span className={`px-2 py-1 rounded-full ${analysisProgress.stage === 'indexing' ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-700'}`}>
                                                    Phase 1: Indexing
                                                </span>
                                                <span className={`px-2 py-1 rounded-full ${analysisProgress.stage === 'analyzing' ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-700'}`}>
                                                    Phase 2: AI Analysis
                                                </span>
                                            </div>

                                            {analysisProgress.total > 0 ? (
                                                <div className="mb-4">
                                                    <div className="w-full bg-blue-200 rounded-full h-3 overflow-hidden" role="progressbar" aria-label="AI analysis progress" aria-valuemin="0" aria-valuemax={analysisProgress.total || 100} aria-valuenow={analysisProgress.current}>
                                                        <div 
                                                            className="bg-blue-600 h-3 rounded-full transition-all duration-500"
                                                            style={{width: `${(analysisProgress.current / analysisProgress.total) * 100}%`}}
                                                        ></div>
                                                    </div>
                                                    <p className="text-sm text-blue-700 mt-2 text-center">
                                                        {Math.round((analysisProgress.current / analysisProgress.total) * 100)}% complete
                                                    </p>
                                                </div>
                                            ) : (
                                                <div className="mb-4">
                                                    <div className="w-full bg-blue-100 rounded-full h-3 overflow-hidden">
                                                        <div className="bg-blue-500 h-3 rounded-full w-1/3 animate-pulse"></div>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            <p className="text-sm text-blue-800 mb-4">{analysisProgress.message}</p>
                                            
                                            <div className="grid grid-cols-2 gap-4">
                                                {analysisProgress.liveVerified.length > 0 && (
                                                    <div>
                                                        <h4 className="text-sm font-semibold text-green-700 mb-2">
                                                             Verified ({analysisProgress.liveVerified.length}):
                                                        </h4>
                                                        <div className="space-y-1 max-h-32 overflow-y-auto">
                                                            {analysisProgress.liveVerified.map((m, i) => (
                                                                <p key={i} className="text-xs text-green-600"> {m.filename}</p>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {analysisProgress.liveUncertain.length > 0 && (
                                                    <div>
                                                        <h4 className="text-sm font-semibold text-yellow-700 mb-2">
                                                             Uncertain ({analysisProgress.liveUncertain.length}):
                                                        </h4>
                                                        <div className="space-y-1 max-h-32 overflow-y-auto">
                                                            {analysisProgress.liveUncertain.map((m, i) => (
                                                                <p key={i} className="text-xs text-yellow-600"> {m.filename}</p>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {analysisResults && !analysisProgress.isAnalyzing && (
                                        <div className="mt-8 space-y-6">
                                            <div>
                                                <div className="flex justify-between items-center mb-4">
                                                    <h3 className="text-xl font-semibold">
                                                         Verified Matches ({analysisResults.verified_matches.length})
                                                    </h3>
                                                    {analysisResults.verified_matches.length > 0 && (
                                                        <button 
                                                            onClick={handleVerifyResumes} 
                                                            disabled={isVerifyingResumes || selectedFiles.size === 0}
                                                            className={`font-bold py-2 px-4 rounded-lg transition flex items-center space-x-2 ${
                                                                verifyStatus === 'completed' 
                                                                    ? 'bg-green-600 hover:bg-green-700' 
                                                                    : 'bg-blue-600 hover:bg-blue-700'
                                                            } text-white disabled:bg-gray-400`}
                                                        >
                                                            {verifyStatus === 'processing' && (
                                                                <>
                                                                    <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                                    </svg>
                                                                    <span>Processing...</span>
                                                                </>
                                                            )}
                                                            
                                                            {verifyStatus === 'completed' && (
                                                                <>
                                                                    <svg className="h-5 w-5 text-white animate-scale-in" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 13l4 4L19 7" />
                                                                    </svg>
                                                                    <span>Completed!</span>
                                                                </>
                                                            )}
                                                            
                                                            {verifyStatus === 'idle' && (
                                                                <span>Move {selectedFiles.size} Selected</span>
                                                            )}
                                                        </button>
                                                    )}
                                                </div>
                                                <div className="bg-gray-50 border border-gray-200 rounded-lg max-h-96 overflow-y-auto">
                                                    {analysisResults.verified_matches.length > 0 ? (
                                                        <table className="min-w-full divide-y divide-gray-200">
                                                            <thead className="bg-gray-100 sticky top-0">
                                                                <tr>
                                                                    <th className="px-4 py-3 text-left">
                                                                        <input type="checkbox" onChange={handleSelectAll} 
                                                                               aria-label="Select all verified matches"
                                                                               checked={selectedFiles.size > 0 && selectedFiles.size === analysisResults.verified_matches.length}/>
                                                                    </th>
                                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Filename</th>
                                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Confidence</th>
                                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reason</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody className="bg-white divide-y divide-gray-200">
                                                                {analysisResults.verified_matches.map((match, i) => (
                                                                    <tr key={i} className={selectedFiles.has(match.filename) ? 'bg-blue-50' : ''}>
                                                                        <td className="px-4 py-4">
                                                                            <input type="checkbox" checked={selectedFiles.has(match.filename)}
                                                                                   aria-label={`Select resume ${match.filename}`}
                                                                                   onChange={() => handleFileSelection(match.filename)}/>
                                                                        </td>
                                                                        <td className="px-6 py-4 text-sm font-medium text-blue-600 hover:underline">
                                                                            <a href={`${API_BASE_URL}/get_resume/${selectedRankFolder}/${encodeURIComponent(match.filename)}`} 
                                                                               target="_blank" rel="noopener noreferrer">
                                                                                {match.filename}
                                                                            </a>
                                                                        </td>
                                                                        <td className="px-6 py-4 text-sm">{getConfidenceBadge(match.confidence)}</td>
                                                                        <td className="px-6 py-4 text-sm text-gray-500">{match.reason}</td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    ) : <p className="text-center text-gray-500 p-4">No verified matches found.</p>}
                                                </div>
                                            </div>

                                            {analysisResults.uncertain_matches && analysisResults.uncertain_matches.length > 0 && (
                                                <div>
                                                    <h3 className="text-xl font-semibold text-yellow-700 mb-4">
                                                         Uncertain Matches - Review Required ({analysisResults.uncertain_matches.length})
                                                    </h3>
                                                    <p className="text-sm text-gray-600 mb-4">
                                                        These matches have lower confidence. Please review and provide feedback to help improve future searches.
                                                    </p>
                                                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 space-y-4">
                                                        {analysisResults.uncertain_matches.map((match, i) => (
                                                            <div key={i} className="bg-white p-4 rounded border border-yellow-200">
                                                                <div className="flex justify-between items-start mb-3">
                                                                    <div className="flex-1">
                                                                        <a href={`${API_BASE_URL}/get_resume/${selectedRankFolder}/${encodeURIComponent(match.filename)}`}
                                                                           target="_blank" rel="noopener noreferrer"
                                                                           className="text-sm font-medium text-blue-600 hover:underline">
                                                                            {match.filename}
                                                                        </a>
                                                                        <p className="text-xs text-gray-600 mt-1">{match.reason}</p>
                                                                    </div>
                                                                    {getConfidenceBadge(match.confidence)}
                                                                </div>
                                                                
                                                                <div className="space-y-2">
                                                                    <textarea
                                                                        placeholder="Add notes (optional)"
                                                                        value={feedbackNotes[match.filename] || ''}
                                                                        onChange={(e) => setFeedbackNotes({...feedbackNotes, [match.filename]: e.target.value})}
                                                                        className="w-full p-2 text-xs border border-gray-300 rounded"
                                                                        rows="2"
                                                                    />
                                                                    <div className="flex space-x-2">
                                                                        <button
                                                                            onClick={() => handleFeedback(match.filename, 'match', match.reason, match.confidence, 'approve')}
                                                                            className="flex-1 bg-green-600 text-white text-sm py-2 px-3 rounded hover:bg-green-700"
                                                                        >
                                                                             Approve Match
                                                                        </button>
                                                                        <button
                                                                            onClick={() => handleFeedback(match.filename, 'match', match.reason, match.confidence, 'reject')}
                                                                            className="flex-1 bg-red-600 text-white text-sm py-2 px-3 rounded hover:bg-red-700"
                                                                        >
                                                                             Reject Match
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}
                            {activeTab === 'dashboard' && <DashboardTabContent />}
                            {activeTab === 'settings' && <SettingsTabContent />}
                        </main>
                    </div>
                </div>
                <div className="fixed top-4 right-4 z-50 space-y-2 w-full max-w-md" aria-live="polite" aria-atomic="false">
                    {toasts.map((toast) => (
                        <div key={toast.id} role={toast.type === 'error' ? 'alert' : 'status'} className={`rounded-lg shadow-lg border px-4 py-3 flex items-start justify-between gap-3 ${toast.type === 'success' ? 'bg-green-50 border-green-200 text-green-900' : 'bg-red-50 border-red-200 text-red-900'}`}>
                            <p className="text-sm">{toast.text}</p>
                            <button
                                onClick={() => dismissToast(toast.id)}
                                className="text-xs font-semibold opacity-70 hover:opacity-100"
                            >
                                Dismiss
                            </button>
                        </div>
                    ))}
                </div>
                {historyModal.open && (
                    <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[80vh] overflow-hidden" role="dialog" aria-modal="true" aria-label={`Candidate history for ${historyModal.candidateId}`}>
                            <div className="flex items-center justify-between px-6 py-4 border-b">
                                <h3 className="text-lg font-semibold">Candidate History: {historyModal.candidateId}</h3>
                                <button
                                    onClick={() => setHistoryModal({ open: false, candidateId: '', rows: [] })}
                                    className="text-gray-500 hover:text-gray-700"
                                >
                                    Close
                                </button>
                            </div>
                            <div className="overflow-y-auto max-h-[65vh] p-4">
                                {historyModal.rows.length === 0 ? (
                                    <p className="text-sm text-gray-600">No history found.</p>
                                ) : (
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-100">
                                            <tr>
                                                <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                                <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Event</th>
                                                <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                                <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-200">
                                            {historyModal.rows.map((item, idx) => (
                                                <tr key={idx}>
                                                    <td className="px-3 py-2 text-sm text-gray-600">{formatDate(item.Date_Added)}</td>
                                                    <td className="px-3 py-2 text-sm">{item.Event_Type || ''}</td>
                                                    <td className="px-3 py-2 text-sm">{item.Status || ''}</td>
                                                    <td className="px-3 py-2 text-sm text-gray-600">{item.Notes || ''}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        </div>
                    </div>
                )}
                </>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
