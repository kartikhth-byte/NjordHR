# NjordHR

## One-Click Local Start (No Manual Terminals)
- Double-click: `start_njordhr.command`
- Windows double-click: `start_njordhr.bat`
- Or run in terminal:
```bash
./scripts/start_njordhr.sh
```

What it does:
- Starts backend and local agent (with duplicate-start protection).
- Auto-selects free ports if defaults are occupied.
- Auto-wires agent `api_base_url` to backend URL.
- Opens browser to the active backend URL.
- Runs backend/agent as background local services (they keep running after browser/app window is closed).
- Auto-shutdown is enabled for launcher-started backend: when no UI tab/app heartbeat is present for ~75s, backend+agent stop automatically.

Stop services:
```bash
./scripts/stop_njordhr.sh
```

Runtime artifacts:
- Logs: `~/Library/Application Support/NjordHR/runtime/` (packaged app)
- Runtime port file: `~/Library/Application Support/NjordHR/runtime/runtime.env` (packaged app)

## Windows Local Start
Run in PowerShell:
```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\windows\start_njordhr.ps1
```

Or double-click:
- `start_njordhr.bat`

Windows startup behavior:
- Starts backend + local agent in background.
- Auto-selects free local ports near `5050`/`5051`.
- Updates agent `api_base_url` to active backend URL.
- Opens browser to active backend URL (unless `-NoOpen` is passed).

## Windows Auto-Start on Login (Task Scheduler)
Install:
```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\windows\install_startup_task.ps1
```

Uninstall:
```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\windows\uninstall_startup_task.ps1
```

Default task name:
- `NjordHRLocalStartup`

## Installer Build Phase (Current)
This repo now includes installer build scaffolding for both platforms.

### macOS: build app bundle + unsigned pkg
```bash
# Default: self-contained runtime embedded in .app
./scripts/packaging/macos/build_app_bundle.sh
./scripts/packaging/macos/build_pkg.sh
./scripts/packaging/macos/install_app.sh
```

Optional toggle (dev-only, no embedded runtime):
```bash
NJORDHR_EMBED_RUNTIME=false ./scripts/packaging/macos/build_app_bundle.sh
```

Outputs:
- `build/macos/NjordHR.app`
- `build/macos/NjordHR-<version>-unsigned.pkg`
- `build/macos/NjordHR-unsigned.pkg` (latest alias)

Installer target path:
- `/Applications/NjordHR.app`

Optional QA install verification:
```bash
./scripts/packaging/macos/qa_install_verify.sh
```

If you had older dev pkg receipts, reset once before testing new installer location:
```bash
sudo pkgutil --forget com.njordhr.desktop || true
sudo pkgutil --forget com.njordhr.desktop.appbundle || true
sudo pkgutil --forget com.njordhr.desktop.localapp || true
```

### Windows: portable zip + Inno Setup installer
Portable ZIP:
```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\packaging\windows\build_portable_zip.ps1
```

Inno installer (requires `iscc.exe`):
```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\packaging\windows\build_inno_installer.ps1
```

Outputs under:
- `build/windows/`

Install desktop/start menu shortcuts on Windows:
```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\windows\install_shortcuts.ps1
```

### Notes
- Current installers are **unsigned** (development phase).
- macOS app bundle is self-contained by default (`NJORDHR_EMBED_RUNTIME=true`) and ships Python runtime + dependencies.
- Next production step is code signing + notarization:
  - macOS: signed/notarized pkg
  - Windows: signed installer executable

### Build Release Folder (Artifacts + Checksums + Manifest)
After building platform installers, create a distribution-ready release bundle:

```bash
./scripts/packaging/create_release_bundle.sh
```

Optional version override:

```bash
./scripts/packaging/create_release_bundle.sh 2026.02.25.1300
```

Output:
- `release/<version>/`
- installer artifacts copied from `build/macos` and `build/windows` (if present)
- `checksums.txt` (SHA256)
- `manifest.json` (version, timestamp, file sizes, SHA256)

## End-User Install (Installer-first)
End users should run installer files, not scripts:

- macOS: latest installer file under `build/macos/`:
  - `NjordHR-<version>-unsigned.pkg` (preferred)
  - `NjordHR-unsigned.pkg` (latest alias)
  - Double-click pkg and complete install.
  - Open app from Applications: `NjordHR`.

- Windows: `build/windows/NjordHR-<version>-setup.exe` (generated by Inno Setup)
  - Run setup wizard.
  - Launch from Start Menu/Desktop shortcut: `NjordHR`.

Scripts remain for developer/admin build pipelines only.

## macOS Auto-Start on Login
Install:
```bash
./scripts/macos/install_launchagent.sh
```

Uninstall:
```bash
./scripts/macos/uninstall_launchagent.sh
```

LaunchAgent label:
- `com.njordhr.local`

## macOS Uninstall (App + optional data cleanup)
Uninstall app and stop services:
```bash
./scripts/packaging/macos/uninstall_app.sh
```

Uninstall app and delete local NjordHR data:
```bash
./scripts/packaging/macos/uninstall_app.sh --remove-data
```

## Local Storage Paths (Exact)
Packaged-app runtime files (macOS):
- Runtime logs: `~/Library/Application Support/NjordHR/runtime/`
- Runtime port map: `~/Library/Application Support/NjordHR/runtime/runtime.env`
- Backend ingest idempotency DB: `~/Library/Application Support/NjordHR/logs/agent_sync_ingest.sqlite3`
- Backend ingest append-only logs: `~/Library/Application Support/NjordHR/logs/agent_job_state.jsonl`, `~/Library/Application Support/NjordHR/logs/agent_job_log.jsonl`, `~/Library/Application Support/NjordHR/logs/agent_candidate_event.jsonl`, `~/Library/Application Support/NjordHR/logs/agent_resume_upload.jsonl`

Agent OS-specific config/state:
- macOS config: `~/Library/Application Support/NjordHR/agent.json`
- macOS state queue: `~/Library/Application Support/NjordHR/state/pending_sync_queue.json`
- Windows config: `%APPDATA%\NjordHR\agent.json`
- Windows state queue: `%APPDATA%\NjordHR\state\pending_sync_queue.json`

Resume/download folders:
- Default agent download folder: `~/Downloads/NjordHR` (macOS/Linux), `%USERPROFILE%\Downloads\NjordHR` (Windows)
- Admin can override download folder in Settings.
- Verified resumes folder is configurable in Admin Settings (`verified_resumes_folder`).

## Runtime Flags
Copy `.env.example` to `.env` (or set env vars in your runtime) to control migration flags:
- `USE_SUPABASE_DB` (default `false`)
- `USE_LOCAL_AGENT` (default `false`)
- `USE_CLOUD_EXPORT` (default `false`)
- `NJORDHR_SERVER_URL` (default `http://127.0.0.1:5000`)
- `NJORDHR_ADMIN_TOKEN` (required for Admin Settings API/UI access)

Setup Wizard installer URL overrides (optional):
- `NJORDHR_MACOS_FULL_INSTALLER_URL`
- `NJORDHR_MACOS_AGENT_INSTALLER_URL`
- `NJORDHR_WINDOWS_FULL_INSTALLER_URL`
- `NJORDHR_WINDOWS_AGENT_INSTALLER_URL`

## Supabase Migrations (Scaffold)
- SQL migrations are under:
  - `supabase/migrations/001_initial_schema.sql`
  - `supabase/migrations/002_rls_baseline.sql`
- Helper script:
  - `python3 scripts/apply_supabase_migrations.py --dry-run`
  - `SUPABASE_DB_URL=postgresql://... python3 scripts/apply_supabase_migrations.py --apply`
- Current runtime remains CSV by default.
- Set `USE_SUPABASE_DB=true` and provide `SUPABASE_URL` + `SUPABASE_SECRET_KEY` (preferred) to enable Supabase repository.
- Legacy fallback: `SUPABASE_SERVICE_ROLE_KEY`.

## Migration Runbook
Use the migration helper to convert legacy CSV layouts into the single master event-log CSV.

### Dry run (no writes)
```bash
python3 scripts/migrate_legacy_csv.py --base-folder Verified_Resumes --dry-run
```

### Real run (writes master CSV)
```bash
python3 scripts/migrate_legacy_csv.py --base-folder Verified_Resumes
```

### Backup and rollback
- Real runs create a backup automatically:
  - `Verified_Resumes/verified_resumes.pre_migration_YYYYMMDD_HHMMSS.csv`
- Rollback:
```bash
cp Verified_Resumes/verified_resumes.pre_migration_YYYYMMDD_HHMMSS.csv Verified_Resumes/verified_resumes.csv
```

## Smoke Tests
Run these after merge/deploy:

```bash
python3 -m unittest -v tests/test_backend_event_log_flow.py
python3 -m unittest -v tests/test_migrate_legacy_csv.py
```

## Export Behavior
- Dashboard export downloads a ZIP with:
  - `selected_candidates.csv`
  - `resumes/<rank>/<filename>.pdf` for files present on disk
- Export response includes:
  - selected count
  - included file count
  - missing file count + preview list

## Admin Settings
- New admin-only endpoints:
  - `GET /admin/settings`
  - `POST /admin/settings`
  - `POST /admin/settings/test_supabase`
  - `POST /admin/settings/change_password`
- Authentication:
  - Header: `X-Admin-Token: <token>`
  - Configure token via `NJORDHR_ADMIN_TOKEN` (recommended) or `[Advanced] admin_token` in `config.ini`.
- Settings UI:
  - Open the `Settings` tab in the app and load with admin token.
  - After admin authentication, all settings are auto-populated (including secrets for that admin session).
  - Secret values are shown only for authenticated admin sessions.
  - Operational settings include `Default Download Folder` and `Verified Resumes Folder` with an admin folder browser picker.
  - Additional operational settings now configurable: `seajob_login_url`, `seajob_dashboard_url`, `otp_window_seconds`, `registry_db_path`, `feedback_db_path`, `log_dir`.
  - Settings page includes a built-in `README` tab describing each setting, value source, and reset guidance.

## Local Agent (M3-T1 to M3-T10 baseline)
A local agent runtime is now available under `agent/` and can run independently from the main backend.

### Run agent
```bash
python3 agent_server.py
```

Default bind:
- `http://127.0.0.1:5051`

Configurable with:
- `NJORDHR_AGENT_HOST`
- `NJORDHR_AGENT_PORT`

### Agent endpoints
- `GET /health`
- `GET /settings`
- `PUT /settings`
- `PUT /settings/download-folder`
- `POST /session/start`
- `POST /session/verify-otp`
- `POST /session/disconnect`
- `GET /session/health`
- `POST /jobs/download`

### Shared Resume Access (Cloud Storage Canonical)
- Verified resumes now attempt upload to Supabase Storage (private bucket, default `resumes`) and store canonical `Resume_URL` as `storage://<bucket>/<path>`.
- Dashboard resume links route through backend `GET /open_resume`, which:
  - issues short-lived signed URL when cloud storage URL exists;
  - falls back to local `GET /get_resume/<rank>/<filename>` for legacy/local-only rows.
- Agent upload endpoint `POST /api/agent/resume-upload` now performs real storage upload (instead of placeholder accept-only response).

### Full Backfill: Move Existing Verified Resumes to Cloud Storage
Dry run:
```bash
python3 scripts/migrate_verified_resumes_to_supabase_storage.py \
  --verified-folder /Users/kartikraghavan/Tools/NjordHR/Verified_Resumes
```

Apply:
```bash
python3 scripts/migrate_verified_resumes_to_supabase_storage.py \
  --verified-folder /Users/kartikraghavan/Tools/NjordHR/Verified_Resumes \
  --apply
```

Required env vars:
- `SUPABASE_URL`
- `SUPABASE_SECRET_KEY` (preferred) or `SUPABASE_SERVICE_ROLE_KEY`
- Optional bucket override: `SUPABASE_RESUME_BUCKET` (default `resumes`)

### Login Roles
- `admin`: full access (Download, AI Search, Dashboard, Setup, Settings)
- `recruiter`: restricted access (AI Search, Dashboard, Setup)

Credential sources:
- Admin username/password:
  - `NJORDHR_ADMIN_USERNAME` / `NJORDHR_ADMIN_PASSWORD`, or
  - `[Auth] admin_username` / `admin_password`, fallback to `NJORDHR_ADMIN_TOKEN`/`[Advanced].admin_token` for password.
- Recruiter username/password:
  - `NJORDHR_RECRUITER_USERNAME` / `NJORDHR_RECRUITER_PASSWORD`, or
  - `[Auth] recruiter_username` / `recruiter_password`
- `GET /jobs/<job_id>`
- `GET /jobs/<job_id>/stream`
- `GET /diagnostics`
- `GET /diagnostics/log-bundle`

### Notes
- Download jobs execute via local scraper and local filesystem.
- Agent includes retry-safe cloud sync queue for job/log/event forwarding.
- Resume cloud upload pipeline is queued and idempotent (requires `api_base_url`, device token, and `cloud_upload_resumes=true` in agent settings).
